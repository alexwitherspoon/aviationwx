name: aviationwx

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: aviationwx
    container_name: aviationwx-web
    ports:
      - "${APP_PORT:-8080}:80"
    volumes:
      # Mount airports.json from host (relative to docker/ directory)
      - ../config/airports.json:/var/www/html/config/airports.json:ro
      # Mount cache directory from /tmp (ephemeral, cleared on reboot)
      - /tmp/aviationwx-cache:/var/www/html/cache
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-aviationwx.org}
      - CONFIG_PATH=/var/www/html/config/airports.json
      - WEATHER_REFRESH_URL=http://localhost
      - AVIATIONWX_LOG_TO_STDOUT=true
      - GIT_SHA=${GIT_SHA:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # VPN Server - strongSwan IPsec server
  # Uses host networking for full VPN functionality (requires Linux or proper host networking support)
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../config/airports.json:/var/www/html/config/airports.json:ro
      - vpn-config:/etc/ipsec-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # VPN Server - OpenVPN server
  # Uses host networking for full VPN functionality
  vpn-openvpn:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-openvpn
    image: aviationwx-vpn-openvpn
    container_name: aviationwx-vpn-openvpn
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun
    volumes:
      - openvpn-config:/etc/openvpn-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "openvpn.*server.conf"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # VPN Server - WireGuard server
  # Uses host networking for full VPN functionality
  vpn-wireguard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-wireguard
    image: aviationwx-vpn-wireguard
    container_name: aviationwx-vpn-wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    devices:
      - /dev/net/tun
    volumes:
      - wireguard-config:/etc/wireguard-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wg", "show", "wg0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # VPN Manager - Manages VPN connections and configuration for all protocols
  # Uses host networking to access VPN servers and manage connections
  vpn-manager:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-manager
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../config/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      - ../config/vpn-clients:/var/www/html/config/vpn-clients
      - vpn-config:/etc/ipsec-shared
      - wireguard-config:/etc/wireguard-shared
      - openvpn-config:/etc/openvpn-shared
    environment:
      - CONFIG_PATH=/var/www/html/config/airports.json
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
      - CLIENT_CONFIG_DIR=/var/www/html/config/vpn-clients
      - VPN_TEST_MODE=true
      - VPN_TEST_CLIENT_IP=127.0.0.1
    restart: unless-stopped
    depends_on:
      - vpn-server
      - vpn-wireguard
      - vpn-openvpn
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # Mock VPN Client - For testing VPN server (optional, uncomment to enable)
  # vpn-client-mock:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile.vpn-client-mock
  #   image: aviationwx-vpn-client-mock
  #   container_name: aviationwx-vpn-client-mock
  #   network_mode: host
  #   cap_add:
  #     - NET_ADMIN
  #     - NET_RAW
  #   environment:
  #     - VPN_SERVER_IP=127.0.0.1
  #     - CONNECTION_NAME=test_vpn
  #     - REMOTE_SUBNET=192.168.1.0/24
  #     - PSK=test-psk-change-me
  #     - IKE_VERSION=2
  #     - ENCRYPTION=aes256gcm128
  #     - DH_GROUP=14
  #   restart: unless-stopped
  #   depends_on:
  #     - vpn-server
  #     - vpn-manager
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "10"

  # Mock VPN Client - For testing VPN server (optional, uncomment to enable)
  # Note: On macOS Docker Desktop, use docker-compose.test-bridge.yml instead
  # vpn-client-mock:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile.vpn-client-mock
  #   image: aviationwx-vpn-client-mock
  #   container_name: aviationwx-vpn-client-mock
  #   network_mode: host
  #   cap_add:
  #     - NET_ADMIN
  #     - NET_RAW
  #   environment:
  #     - VPN_SERVER_IP=127.0.0.1
  #     - CONNECTION_NAME=test_vpn
  #     - REMOTE_SUBNET=192.168.1.0/24
  #     - PSK=test-psk-change-me
  #     - IKE_VERSION=2
  #     - ENCRYPTION=aes256gcm128
  #     - DH_GROUP=14
  #   restart: unless-stopped
  #   depends_on:
  #     - vpn-server
  #     - vpn-manager
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "10"

volumes:
  vpn-config:
  wireguard-config:
  openvpn-config:

