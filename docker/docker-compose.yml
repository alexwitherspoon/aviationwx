name: aviationwx

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: aviationwx
    container_name: aviationwx-web
    ports:
      - "${APP_PORT:-8080}:80"
      # Expose FTP/FTPS and SFTP ports for local testing
      # Using non-standard ports to avoid conflicts with system services
      - "12121:2121"  # FTP/FTPS (mapped to avoid conflicts)
      - "12222:2222"  # SFTP (mapped to avoid conflicts)
    volumes:
      # Mount airports.json from host (relative to docker/ directory)
      - ../config/airports.json:/var/www/html/config/airports.json:ro
      # Mount cache directory from /tmp (ephemeral, cleared on reboot)
      - /tmp/aviationwx-cache:/var/www/html/cache
      # SFTP chroot directory - must be at /var/sftp/ inside container
      # because SSH chroot requires ALL parent directories to be root-owned
      - /tmp/aviationwx-cache/sftp:/var/sftp
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-aviationwx.org}
      - CONFIG_PATH=${CONFIG_PATH:-/var/www/html/config/airports.json}
      - APP_ENV=${APP_ENV:-}
      - WEATHER_REFRESH_URL=http://localhost
      - GIT_SHA=${GIT_SHA:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"
