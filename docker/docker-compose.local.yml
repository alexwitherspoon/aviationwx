# Local Development Docker Compose Configuration
# This is an example file for local development
# 
# For user-specific overrides (like custom airports.json paths), create:
# docker-compose.override.yml (gitignored, not checked in)
#
# Usage:
#   docker compose -f docker/docker-compose.local.yml up
#   or use: make up (which uses this file)

name: aviationwx-local

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: aviationwx-local
    container_name: aviationwx-web-local
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
      # Expose FTP/FTPS and SFTP ports for local testing
      # Using non-standard ports to avoid conflicts with system services
      - "12121:2121"  # FTP/FTPS (mapped to avoid conflicts)
      - "12222:2222"  # SFTP (mapped to avoid conflicts)
    volumes:
      # Mount config directory for local development (writable so entrypoint can create airports.json from fallback)
      # Entrypoint will handle fallback: airports.json (if exists) > airports.json.example > airports.json.test
      # For local development with real airports.json, create config/airports.json or use docker-compose.override.yml
      - ../config:/var/www/html/config
      # Also mount tests directory so test fixture is available as fallback
      - ../tests:/var/www/html/tests:ro
      # Mount cache directory from /tmp (ephemeral, cleared on reboot)
      - /tmp/aviationwx-cache:/var/www/html/cache
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-localhost}
      - CONFIG_PATH=/var/www/html/config/airports.json
      - WEATHER_REFRESH_URL=http://localhost
      - AVIATIONWX_LOG_TO_STDOUT=true
      - GIT_SHA=${GIT_SHA:-}
      - MOCK_WEATHER=${MOCK_WEATHER:-true}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Server - strongSwan IPsec server
  # Uses host networking for full VPN functionality (requires Linux or proper host networking support)
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn-local
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../config:/var/www/html/config:ro
      - ../tests:/var/www/html/tests:ro
      - vpn-config:/etc/ipsec-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Manager - Manages VPN connections and configuration
  # Uses host networking to access VPN server and manage connections
  vpn-manager:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-manager-local
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../config:/var/www/html/config:ro
      - ../tests:/var/www/html/tests:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      - vpn-config:/etc/ipsec-shared
    environment:
      - CONFIG_PATH=/var/www/html/config/airports.json
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
      - VPN_TEST_MODE=true
      - VPN_TEST_CLIENT_IP=127.0.0.1
    restart: unless-stopped
    depends_on:
      - vpn-server
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

volumes:
  vpn-config:
