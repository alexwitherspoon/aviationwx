# Local Development Docker Compose Configuration
# 
# This file provides a clean base configuration for local development.
# It uses the built Docker image without source mounts.
#
# For local development with live code reloading, create docker-compose.override.yml
# (gitignored) with source directory mounts and your secrets path.
# See docker-compose.override.yml.example for a template.
#
# Usage:
#   docker compose -f docker/docker-compose.local.yml up
#   or use: make up (which also loads docker-compose.override.yml if present)

name: aviationwx-local

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: aviationwx-local
    container_name: aviationwx-web-local
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
      # Expose FTP/FTPS and SFTP ports for push webcam testing
      - "12121:2121"  # FTP/FTPS (non-standard to avoid conflicts)
      - "12222:2222"  # SFTP (non-standard to avoid conflicts)
    volumes:
      # Cache directory (ephemeral)
      - /tmp/aviationwx-cache:/var/www/html/cache
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-localhost}
      - CONFIG_PATH=${CONFIG_PATH:-/var/www/html/config/airports.json}
      - WEATHER_REFRESH_URL=http://localhost
      - AVIATIONWX_LOG_TO_STDOUT=true
      - GIT_SHA=${GIT_SHA:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Server - strongSwan IPsec server
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn-local
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - vpn-config:/etc/ipsec-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Manager - Manages VPN connections and configuration
  vpn-manager:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-manager-local
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /tmp/aviationwx-cache:/var/www/html/cache
      - vpn-config:/etc/ipsec-shared
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/var/www/html/config/airports.json}
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
      - VPN_TEST_MODE=true
      - VPN_TEST_CLIENT_IP=127.0.0.1
    restart: unless-stopped
    depends_on:
      - vpn-server
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

volumes:
  vpn-config:
