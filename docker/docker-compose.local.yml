# Local Development Docker Compose Configuration
# 
# This file provides a clean base configuration for local development.
# It uses the built Docker image without source mounts.
#
# For local development with live code reloading, create docker-compose.override.yml
# (gitignored) with source directory mounts and your secrets path.
# See docker-compose.override.yml.example for a template.
#
# Usage:
#   docker compose -f docker/docker-compose.local.yml up
#   or use: make up (which also loads docker-compose.override.yml if present)

name: aviationwx-local

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: aviationwx-local
    container_name: aviationwx-web-local
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
      # Expose FTP/FTPS and SFTP ports for push webcam testing
      - "12121:2121"  # FTP/FTPS (non-standard to avoid conflicts)
      - "12222:2222"  # SFTP (non-standard to avoid conflicts)
    volumes:
      # Cache directory (ephemeral)
      - /tmp/aviationwx-cache:/var/www/html/cache
      # SFTP chroot directory (SSH chroot requires root-owned parent dirs)
      - /tmp/aviationwx-sftp:/var/sftp
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-localhost}
      - CONFIG_PATH=${CONFIG_PATH:-/var/www/html/config/airports.json}
      - WEATHER_REFRESH_URL=http://localhost
      - GIT_SHA=${GIT_SHA:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"
