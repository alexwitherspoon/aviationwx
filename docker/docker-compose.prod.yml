name: aviationwx

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # BuildKit automatically uses local build cache from previous builds
      # No registry cache configured - all caching is local-only
    image: aviationwx
    container_name: aviationwx-web
    restart: always
    ports:
      - "127.0.0.1:${APP_PORT:-8080}:80"  # Bind to localhost only, Nginx handles external
      - "2121:2121"  # FTP/FTPS (both protocols on same port)
      - "2222:2222"  # SFTP
      # FTP passive mode ports (50000-50099) - 100 ports for concurrent connections
      # Generated by scripts/generate-ftp-ports.sh
      - "50000:50000"  # FTP passive mode
      - "50001:50001"  # FTP passive mode
      - "50002:50002"  # FTP passive mode
      - "50003:50003"  # FTP passive mode
      - "50004:50004"  # FTP passive mode
      - "50005:50005"  # FTP passive mode
      - "50006:50006"  # FTP passive mode
      - "50007:50007"  # FTP passive mode
      - "50008:50008"  # FTP passive mode
      - "50009:50009"  # FTP passive mode
      - "50010:50010"  # FTP passive mode
      - "50011:50011"  # FTP passive mode
      - "50012:50012"  # FTP passive mode
      - "50013:50013"  # FTP passive mode
      - "50014:50014"  # FTP passive mode
      - "50015:50015"  # FTP passive mode
      - "50016:50016"  # FTP passive mode
      - "50017:50017"  # FTP passive mode
      - "50018:50018"  # FTP passive mode
      - "50019:50019"  # FTP passive mode
      - "50020:50020"  # FTP passive mode
      - "50021:50021"  # FTP passive mode
      - "50022:50022"  # FTP passive mode
      - "50023:50023"  # FTP passive mode
      - "50024:50024"  # FTP passive mode
      - "50025:50025"  # FTP passive mode
      - "50026:50026"  # FTP passive mode
      - "50027:50027"  # FTP passive mode
      - "50028:50028"  # FTP passive mode
      - "50029:50029"  # FTP passive mode
      - "50030:50030"  # FTP passive mode
      - "50031:50031"  # FTP passive mode
      - "50032:50032"  # FTP passive mode
      - "50033:50033"  # FTP passive mode
      - "50034:50034"  # FTP passive mode
      - "50035:50035"  # FTP passive mode
      - "50036:50036"  # FTP passive mode
      - "50037:50037"  # FTP passive mode
      - "50038:50038"  # FTP passive mode
      - "50039:50039"  # FTP passive mode
      - "50040:50040"  # FTP passive mode
      - "50041:50041"  # FTP passive mode
      - "50042:50042"  # FTP passive mode
      - "50043:50043"  # FTP passive mode
      - "50044:50044"  # FTP passive mode
      - "50045:50045"  # FTP passive mode
      - "50046:50046"  # FTP passive mode
      - "50047:50047"  # FTP passive mode
      - "50048:50048"  # FTP passive mode
      - "50049:50049"  # FTP passive mode
      - "50050:50050"  # FTP passive mode
      - "50051:50051"  # FTP passive mode
      - "50052:50052"  # FTP passive mode
      - "50053:50053"  # FTP passive mode
      - "50054:50054"  # FTP passive mode
      - "50055:50055"  # FTP passive mode
      - "50056:50056"  # FTP passive mode
      - "50057:50057"  # FTP passive mode
      - "50058:50058"  # FTP passive mode
      - "50059:50059"  # FTP passive mode
      - "50060:50060"  # FTP passive mode
      - "50061:50061"  # FTP passive mode
      - "50062:50062"  # FTP passive mode
      - "50063:50063"  # FTP passive mode
      - "50064:50064"  # FTP passive mode
      - "50065:50065"  # FTP passive mode
      - "50066:50066"  # FTP passive mode
      - "50067:50067"  # FTP passive mode
      - "50068:50068"  # FTP passive mode
      - "50069:50069"  # FTP passive mode
      - "50070:50070"  # FTP passive mode
      - "50071:50071"  # FTP passive mode
      - "50072:50072"  # FTP passive mode
      - "50073:50073"  # FTP passive mode
      - "50074:50074"  # FTP passive mode
      - "50075:50075"  # FTP passive mode
      - "50076:50076"  # FTP passive mode
      - "50077:50077"  # FTP passive mode
      - "50078:50078"  # FTP passive mode
      - "50079:50079"  # FTP passive mode
      - "50080:50080"  # FTP passive mode
      - "50081:50081"  # FTP passive mode
      - "50082:50082"  # FTP passive mode
      - "50083:50083"  # FTP passive mode
      - "50084:50084"  # FTP passive mode
      - "50085:50085"  # FTP passive mode
      - "50086:50086"  # FTP passive mode
      - "50087:50087"  # FTP passive mode
      - "50088:50088"  # FTP passive mode
      - "50089:50089"  # FTP passive mode
      - "50090:50090"  # FTP passive mode
      - "50091:50091"  # FTP passive mode
      - "50092:50092"  # FTP passive mode
      - "50093:50093"  # FTP passive mode
      - "50094:50094"  # FTP passive mode
      - "50095:50095"  # FTP passive mode
      - "50096:50096"  # FTP passive mode
      - "50097:50097"  # FTP passive mode
      - "50098:50098"  # FTP passive mode
      - "50099:50099"  # FTP passive mode
    volumes:
      # Mount airports.json from user home directory (deployed by secrets repo GitHub Actions)
      # PRODUCTION: This file MUST exist - application will fail if missing (no fallback to test files)
      # Docker will fail to start if the source file doesn't exist (unless using a bind mount that allows missing files)
      # Application code will also fail fast if file is missing in production
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      # Note: /var/www/html/uploads is ephemeral (inside container only)
      # Files are uploaded via SFTP/FTP/FTPS, then processed and moved to cache
      - /etc/letsencrypt:/etc/letsencrypt:rw  # Let's Encrypt certificates (rw needed for certbot to write)
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-aviationwx.org}
      - CONFIG_PATH=/var/www/html/config/airports.json
      - WEBCAM_REFRESH_DEFAULT=${WEBCAM_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_DEFAULT=${WEATHER_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_URL=http://localhost
      - AVIATIONWX_LOG_TO_STDOUT=true
      - GIT_SHA=${GIT_SHA:-}
    healthcheck:
      # Override Dockerfile healthcheck with longer start_period
      # Dockerfile has 5s which is too short for all services (cron, vsftpd, sshd, fail2ban, Apache)
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 20s  # Give services time to start before healthcheck begins
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Server - strongSwan IPsec server
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - vpn-config:/etc/ipsec-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Manager - Manages VPN connections and configuration
  vpn-manager:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-manager
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      - vpn-config:/etc/ipsec-shared
    environment:
      - CONFIG_PATH=/var/www/html/config/airports.json
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
    restart: unless-stopped
    depends_on:
      - vpn-server
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: aviationwx-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../docker/nginx-main.conf:/etc/nginx/nginx.conf:ro
      - ../docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../ssl:/etc/nginx/ssl:ro  # SSL certificates
    depends_on:
      - web
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

volumes:
  vpn-config:

