name: aviationwx

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # BuildKit automatically uses local build cache from previous builds
      # No registry cache configured - all caching is local-only
    image: aviationwx
    container_name: aviationwx-web
    restart: always
    ports:
      - "127.0.0.1:${APP_PORT:-8080}:80"  # Bind to localhost only, Nginx handles external
      - "2121:2121"  # FTP/FTPS (both protocols on same port)
      - "2222:2222"  # SFTP
      # FTP passive mode ports (50000-50019) - Published individually since Docker Compose doesn't support ranges
      - "50000:50000"  # FTP passive mode
      - "50001:50001"  # FTP passive mode
      - "50002:50002"  # FTP passive mode
      - "50003:50003"  # FTP passive mode
      - "50004:50004"  # FTP passive mode
      - "50005:50005"  # FTP passive mode
      - "50006:50006"  # FTP passive mode
      - "50007:50007"  # FTP passive mode
      - "50008:50008"  # FTP passive mode
      - "50009:50009"  # FTP passive mode
      - "50010:50010"  # FTP passive mode
      - "50011:50011"  # FTP passive mode
      - "50012:50012"  # FTP passive mode
      - "50013:50013"  # FTP passive mode
      - "50014:50014"  # FTP passive mode
      - "50015:50015"  # FTP passive mode
      - "50016:50016"  # FTP passive mode
      - "50017:50017"  # FTP passive mode
      - "50018:50018"  # FTP passive mode
      - "50019:50019"  # FTP passive mode
    volumes:
      # Mount airports.json from user home directory (deployed by secrets repo GitHub Actions)
      - /home/aviationwx/airports.json:/var/www/html/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      # Note: /var/www/html/uploads is ephemeral (inside container only)
      # Files are uploaded via SFTP/FTP/FTPS, then processed and moved to cache
      - /etc/letsencrypt:/etc/letsencrypt:rw  # Let's Encrypt certificates (rw needed for certbot to write)
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-aviationwx.org}
      - CONFIG_PATH=/var/www/html/airports.json
      - WEBCAM_REFRESH_DEFAULT=${WEBCAM_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_DEFAULT=${WEATHER_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_URL=http://localhost
      - AVIATIONWX_LOG_TO_STDOUT=true
      - GIT_SHA=${GIT_SHA:-}
    healthcheck:
      # Override Dockerfile healthcheck with longer start_period
      # Dockerfile has 5s which is too short for all services (cron, vsftpd, sshd, fail2ban, Apache)
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 20s  # Give services time to start before healthcheck begins
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Server - strongSwan IPsec server
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - vpn-config:/etc/ipsec-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Manager - Manages VPN connections and configuration
  vpn-manager:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-manager
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      - vpn-config:/etc/ipsec-shared
    environment:
      - CONFIG_PATH=/var/www/html/config/airports.json
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
    restart: unless-stopped
    depends_on:
      - vpn-server
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: aviationwx-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../docker/nginx-main.conf:/etc/nginx/nginx.conf:ro
      - ../docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../ssl:/etc/nginx/ssl:ro  # SSL certificates
    depends_on:
      - web
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

volumes:
  vpn-config:

