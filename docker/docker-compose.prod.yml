name: aviationwx

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # BuildKit automatically uses local build cache from previous builds
      # No registry cache configured - all caching is local-only
    image: aviationwx
    container_name: aviationwx-web
    restart: always
    network_mode: host  # Use host networking to eliminate port mapping overhead
    # Ports are now directly on host (no port mappings needed):
    # - 8080 (HTTP, Apache, internal - behind nginx on port 80)
    # - 2121 (FTP/FTPS)
    # - 2222 (SFTP)
    # - 50000-51000 (FTP passive mode, 1001 ports)
    volumes:
      # Mount airports.json from user home directory (deployed by secrets repo GitHub Actions)
      # PRODUCTION: This file MUST exist - application will fail if missing (no fallback to test files)
      # Docker will fail to start if the source file doesn't exist (unless using a bind mount that allows missing files)
      # Application code will also fail fast if file is missing in production
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      # Mount partner-logos from user home directory (deployed by secrets repo GitHub Actions)
      # These logos are kept private in the secrets repo and deployed alongside airports.json
      - /home/aviationwx/partner-logos:/var/www/html/partner-logos:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      # SFTP chroot directory - must be at /var/sftp/ inside container
      # because SSH chroot requires ALL parent directories to be root-owned
      # /var/www/html/ is www-data owned, so we use /var/sftp/ instead
      # Host path is under cache for organizational consistency
      - /tmp/aviationwx-cache/sftp:/var/sftp
      # Note: FTP uploads go to /var/www/html/cache/uploads/ (inside cache mount)
      - /etc/letsencrypt:/etc/letsencrypt:rw  # Let's Encrypt certificates (rw needed for certbot to write)
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    env_file:
      - /home/aviationwx/.env.production
    environment:
      # Core configuration (can override env_file values if needed)
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-aviationwx.org}
      - CONFIG_PATH=/var/www/html/config/airports.json
      - APP_ENV=production
      - WEBCAM_REFRESH_DEFAULT=${WEBCAM_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_DEFAULT=${WEATHER_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_URL=http://localhost:8080
      - GIT_SHA=${GIT_SHA:-}
      # Sentry configuration (from env_file)
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
      - SENTRY_SAMPLE_RATE_ERRORS=${SENTRY_SAMPLE_RATE_ERRORS:-1.0}
      - SENTRY_SAMPLE_RATE_TRACES=${SENTRY_SAMPLE_RATE_TRACES:-0.05}
      - SENTRY_RELEASE=${GIT_SHA:-}
    healthcheck:
      # Override Dockerfile healthcheck with longer start_period
      # Dockerfile has 5s which is too short for all services (cron, vsftpd, sshd, fail2ban, Apache)
      # Check Apache on port 8080 (internal port, behind nginx on port 80)
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 20s  # Give services time to start before healthcheck begins
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: aviationwx-nginx
    restart: always
    network_mode: host  # Use host networking to access web service on localhost
    # Ports are now directly on host (no port mappings needed):
    # - 80 (HTTP)
    # - 443 (HTTPS)
    volumes:
      - ../docker/nginx-main.conf:/etc/nginx/nginx.conf:ro
      - ../docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../ssl:/etc/nginx/ssl:ro  # SSL certificates
    depends_on:
      - web
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"
