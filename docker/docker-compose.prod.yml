name: aviationwx

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # BuildKit automatically uses local build cache from previous builds
      # No registry cache configured - all caching is local-only
    image: aviationwx
    container_name: aviationwx-web
    restart: always
    network_mode: host  # Use host networking to eliminate port mapping overhead
    # Ports are now directly on host (no port mappings needed):
    # - 8080 (HTTP, Apache, internal - behind nginx on port 80)
    # - 2121 (FTP/FTPS)
    # - 2222 (SFTP)
    # - 50000-50099 (FTP passive mode, 100 ports)
    volumes:
      # Mount airports.json from user home directory (deployed by secrets repo GitHub Actions)
      # PRODUCTION: This file MUST exist - application will fail if missing (no fallback to test files)
      # Docker will fail to start if the source file doesn't exist (unless using a bind mount that allows missing files)
      # Application code will also fail fast if file is missing in production
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      # Note: /var/www/html/uploads is ephemeral (inside container only)
      # Files are uploaded via SFTP/FTP/FTPS, then processed and moved to cache
      - /etc/letsencrypt:/etc/letsencrypt:rw  # Let's Encrypt certificates (rw needed for certbot to write)
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - APACHE_DOCUMENT_ROOT=/var/www/html
      - DOMAIN=${DOMAIN:-aviationwx.org}
      - CONFIG_PATH=/var/www/html/config/airports.json
      - WEBCAM_REFRESH_DEFAULT=${WEBCAM_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_DEFAULT=${WEATHER_REFRESH_DEFAULT:-60}
      - WEATHER_REFRESH_URL=http://localhost:8080
      - AVIATIONWX_LOG_TO_STDOUT=true
      - GIT_SHA=${GIT_SHA:-}
    healthcheck:
      # Override Dockerfile healthcheck with longer start_period
      # Dockerfile has 5s which is too short for all services (cron, vsftpd, sshd, fail2ban, Apache)
      # Check Apache on port 8080 (internal port, behind nginx on port 80)
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 20s  # Give services time to start before healthcheck begins
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Server - strongSwan IPsec server
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - vpn-config:/etc/ipsec-shared:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # VPN Manager - Manages VPN connections and configuration
  vpn-manager:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-manager
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /home/aviationwx/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      - vpn-config:/etc/ipsec-shared
    environment:
      - CONFIG_PATH=/var/www/html/config/airports.json
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
    restart: unless-stopped
    depends_on:
      - vpn-server
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: aviationwx-nginx
    restart: always
    network_mode: host  # Use host networking to access web service on localhost
    # Ports are now directly on host (no port mappings needed):
    # - 80 (HTTP)
    # - 443 (HTTPS)
    volumes:
      - ../docker/nginx-main.conf:/etc/nginx/nginx.conf:ro
      - ../docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../ssl:/etc/nginx/ssl:ro  # SSL certificates
    depends_on:
      - web
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
        tag: "{{.Name}}/{{.ID}}"

volumes:
  vpn-config:

