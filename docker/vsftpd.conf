# vsftpd Dual-Stack Configuration for Push Webcams
# Single instance handles both IPv4 and IPv6 connections
# pasv_address will be set dynamically by entrypoint script via DNS resolution

# Dual-stack listening (IPv6 socket accepts both IPv4 and IPv6)
# Per vsftpd docs: listen and listen_ipv6 are mutually exclusive
listen=NO
listen_ipv6=YES
listen_port=2121
anonymous_enable=NO
local_enable=YES
write_enable=YES
# umask 002 creates files with 664 (rw-rw-r--) and directories with 775
# This allows www-data (in same group) to write to uploaded files for EXIF processing
local_umask=002
dirmessage_enable=YES
use_localtime=YES
xferlog_enable=YES
connect_from_port_20=YES

# Virtual users (for push webcams)
pam_service_name=vsftpd
guest_enable=YES
guest_username=ftp
virtual_use_local_privs=YES
user_sub_token=$USER
# Per-user config files specify local_root as /uploads/{airport}/{username}
# This provides namespace isolation - cameras can only access their airport's folder
user_config_dir=/etc/vsftpd/users
hide_ids=YES
allow_writeable_chroot=YES

# Chroot all users to their home directory
chroot_local_user=YES
chroot_list_enable=NO

# Passive mode settings (required for clients behind firewalls)
pasv_enable=YES
pasv_min_port=50000
pasv_max_port=51000
# pasv_address will be set dynamically by entrypoint script to detect external IP
# This should be the public IP or hostname that clients can reach
# pasv_address=

# Logging
xferlog_std_format=NO
log_ftp_protocol=YES
vsftpd_log_file=/var/log/vsftpd.log
dual_log_enable=YES

# Security settings
ascii_upload_enable=NO
ascii_download_enable=NO
ftpd_banner=Welcome to AviationWX Push Webcam FTP
deny_email_enable=NO
secure_chroot_dir=/var/run/vsftpd/empty
ls_recurse_enable=NO

# Timeout settings
idle_session_timeout=300
data_connection_timeout=120

# SSL/TLS settings (will be enabled by entrypoint if certs available)
ssl_enable=NO
# rsa_cert_file=/etc/letsencrypt/live/aviationwx.org/fullchain.pem
# rsa_private_key_file=/etc/letsencrypt/live/aviationwx.org/privkey.pem
# ssl_tlsv1=YES
# ssl_sslv2=NO
# ssl_sslv3=NO
# require_ssl_reuse=NO - CRITICAL: Must be NO for Go FTPS clients (AviationWX Bridge)
#   Go's crypto/tls doesn't properly implement TLS session reuse, causing data
#   connection failures when vsftpd enforces session reuse. This is a known
#   interoperability issue with minimal security impact (both connections still TLS).
# ssl_ciphers=HIGH
