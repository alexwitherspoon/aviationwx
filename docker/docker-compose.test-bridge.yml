# Docker Compose for VPN testing with bridge networking (works on macOS)
# Usage: docker-compose -f docker-compose.yml -f docker-compose.test-bridge.yml up
#
# This uses bridge networking instead of host mode, which works better on macOS Docker Desktop
# Note: This requires port mapping and may have limitations, but allows basic connection testing

name: aviationwx-test-bridge

services:
  # VPN Server - using bridge network instead of host
  vpn-server-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-server
    image: aviationwx-vpn-server
    container_name: aviationwx-vpn-test-server
    # Use bridge network instead of host
    networks:
      - vpn-test-network
    cap_add:
      - NET_ADMIN
      - NET_RAW
    ports:
      - "500:500/udp"   # IKE
      - "4500:4500/udp" # NAT-T
    volumes:
      - ../config/airports.json:/var/www/html/config/airports.json:ro
      - vpn-config-test:/etc/ipsec-shared:ro
    restart: unless-stopped
    environment:
      - VPN_TEST_MODE=true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # VPN Manager - using bridge network
  vpn-manager-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-manager
    image: aviationwx-vpn-manager
    container_name: aviationwx-vpn-test-manager
    networks:
      - vpn-test-network
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../config/airports.json:/var/www/html/config/airports.json:ro
      - /tmp/aviationwx-cache:/var/www/html/cache
      - vpn-config-test:/etc/ipsec-shared
    environment:
      - CONFIG_PATH=/var/www/html/config/airports.json
      - STATUS_FILE=/var/www/html/cache/vpn-status.json
      - VPN_TEST_MODE=true
    restart: unless-stopped
    depends_on:
      - vpn-server-test
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

  # Mock VPN Client - using bridge network, connects to server via service name
  vpn-client-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vpn-client-mock
    image: aviationwx-vpn-client-mock
    container_name: aviationwx-vpn-test-client
    networks:
      - vpn-test-network
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - VPN_SERVER_IP=vpn-server-test  # Use service name instead of IP
      - CONNECTION_NAME=test_vpn
      - REMOTE_SUBNET=192.168.1.0/24
      - PSK=test-psk-for-local-testing-only
      - IKE_VERSION=2
      - ENCRYPTION=aes256gcm128
      - DH_GROUP=14
    # Give extra time for server to be ready
    healthcheck:
      test: ["CMD", "ipsec", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    depends_on:
      - vpn-server-test
      - vpn-manager-test
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"

networks:
  vpn-test-network:
    driver: bridge

volumes:
  vpn-config-test:

