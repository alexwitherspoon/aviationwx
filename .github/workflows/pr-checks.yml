name: PR Quality Gates

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened, ready_for_review ]

# Prevent concurrent runs - cancel old runs when PR is updated
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Default permissions for all jobs in this workflow
permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  quality-gates:
    name: Quality Gates (Block PR if Failed)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: pcov
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Validate PHP syntax
        run: |
          errors=$(find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; 2>&1 | grep -v "No syntax errors" || true)
          if [ ! -z "$errors" ]; then
            echo "❌ PHP syntax errors found:"
            echo "$errors"
            exit 1
          else
            echo "✓ All PHP files have valid syntax"
          fi
      
      - name: Validate Stale Data Safety Implementation
        run: |
          # Check that staleness.php is required (functions moved to library)
          if ! grep -q "require.*staleness\.php\|include.*staleness\.php" api/weather.php; then
            echo "❌ CRITICAL: lib/weather/staleness.php not required in api/weather.php!"
            exit 1
          fi
          
          # Verify nullStaleFieldsBySource function exists in staleness.php
          if ! grep -q "function nullStaleFieldsBySource" lib/weather/staleness.php; then
            echo "❌ CRITICAL: nullStaleFieldsBySource function missing from lib/weather/staleness.php!"
            exit 1
          fi
          
          # Verify mergeWeatherDataWithFallback function exists in staleness.php
          if ! grep -q "function mergeWeatherDataWithFallback" lib/weather/staleness.php; then
            echo "❌ CRITICAL: mergeWeatherDataWithFallback function missing from lib/weather/staleness.php!"
            exit 1
          fi
          
          # Verify functions are being called in api/weather.php
          if ! grep -q "nullStaleFieldsBySource" api/weather.php; then
            echo "❌ CRITICAL: nullStaleFieldsBySource not being used in api/weather.php!"
            exit 1
          fi
          
          if ! grep -q "mergeWeatherDataWithFallback" api/weather.php; then
            echo "❌ CRITICAL: mergeWeatherDataWithFallback not being used in api/weather.php!"
            exit 1
          fi
          
          if ! grep -q "MAX_STALE_HOURS\|maxStaleHours.*3" api/weather.php; then
            echo "⚠️  Warning: Stale data threshold may not be set correctly"
          fi
          
          if ! grep -q "temp_high_today.*temp_low_today.*peak_gust_today" api/weather.php; then
            echo "⚠️  Warning: Daily tracking values preservation may be missing"
          fi
          
          if ! grep -q "wdir.*VRB\|'VRB'" api/weather.php; then
            echo "⚠️  Warning: VRB (variable wind direction) handling may be missing"
          fi
          
          if ! grep -q "try.*catch.*Exception\|try.*catch.*Throwable" api/weather.php; then
            echo "⚠️  Warning: Error handling around parsing may be missing"
          fi
          
          echo "✓ Stale data safety validation complete"
      
      - name: Validate Push Webcam Implementation
        run: |
          if ! grep -q "function validatePushWebcamConfig" lib/push-webcam-validator.php; then
            echo "❌ CRITICAL: validatePushWebcamConfig function missing!"
            exit 1
          fi
          
          if ! grep -q "function processPushWebcams" scripts/process-push-webcams.php; then
            echo "❌ CRITICAL: processPushWebcams function missing!"
            exit 1
          fi
          
          if ! grep -q "function syncPushConfig" scripts/sync-push-config.php; then
            echo "❌ CRITICAL: syncPushConfig function missing!"
            exit 1
          fi
          
          if ! grep -q "refresh_seconds.*5\|5.*refresh_seconds" pages/status.php scripts/process-push-webcams.php; then
            echo "⚠️  Warning: Staleness warning threshold (5x) may not be implemented"
          fi
          
          if ! grep -q "refresh_seconds.*10\|10.*refresh_seconds" pages/status.php scripts/process-push-webcams.php; then
            echo "⚠️  Warning: Staleness error threshold (10x) may not be implemented"
          fi
          
          if ! grep -q "60\|min.*60" scripts/process-push-webcams.php lib/push-webcam-validator.php; then
            echo "⚠️  Warning: Minimum refresh_seconds (60s) enforcement may be missing"
          fi
          
          if ! grep -q "validateImageFile\|mime_content_type\|getimagesize" scripts/process-push-webcams.php; then
            echo "⚠️  Warning: Image file validation may be missing"
          fi
          
          echo "✓ Push webcam implementation validation complete"
      
      - name: Validate Flight Category Logic
        run: |
          # Check that calculator.php is required (functions moved to library)
          if ! grep -q "require.*calculator\.php\|include.*calculator\.php" api/weather.php; then
            echo "❌ CRITICAL: lib/weather/calculator.php not required in api/weather.php!"
            exit 1
          fi
          
          # Verify calculateFlightCategory function exists in calculator.php
          if ! grep -q "function calculateFlightCategory" lib/weather/calculator.php; then
            echo "❌ CRITICAL: calculateFlightCategory function missing from lib/weather/calculator.php!"
            exit 1
          fi
          
          # Verify function is being called in api/weather.php
          if ! grep -q "calculateFlightCategory" api/weather.php; then
            echo "❌ CRITICAL: calculateFlightCategory not being used in api/weather.php!"
            exit 1
          fi
          
          categories=("LIFR" "IFR" "MVFR" "VFR")
          for category in "${categories[@]}"; do
            if ! grep -q "return '$category'" lib/weather/calculator.php; then
              echo "⚠️  Warning: Flight category $category may not be handled in lib/weather/calculator.php"
            fi
          done
          
          echo "✓ Flight category validation complete"
      
      - name: Check for Breaking Changes
        run: |
          critical_functions=(
            "calculateFlightCategory"
            "calculateDensityAltitude"
            "calculatePressureAltitude"
            "nullStaleFieldsBySource"
            "mergeWeatherDataWithFallback"
            "validateAirportId"
            "checkRateLimit"
            "checkRateLimitFileBased"
            "checkWeatherCircuitBreaker"
            "recordWeatherFailure"
            "recordWeatherSuccess"
            "checkWebcamCircuitBreaker"
            "recordWebcamFailure"
            "recordWebcamSuccess"
            "validatePushWebcamConfig"
            "processPushWebcams"
            "syncPushConfig"
          )
          
          for func in "${critical_functions[@]}"; do
            if ! grep -q "function $func" api/weather.php lib/config.php lib/rate-limit.php lib/circuit-breaker.php lib/push-webcam-validator.php scripts/process-push-webcams.php scripts/sync-push-config.php scripts/fetch-webcam.php 2>/dev/null; then
              echo "❌ CRITICAL: Function $func missing or removed!"
              exit 1
            fi
          done
          
          echo "✓ No breaking changes detected"
      
      - name: Validate API Response Structure
        run: |
          if ! grep -q "Content-Type: application/json" api/weather.php; then
            echo "❌ CRITICAL: API response doesn't set JSON header!"
            exit 1
          fi
          
          if ! grep -q "success.*false" api/weather.php; then
            echo "⚠️  Warning: Error response structure may be missing"
          fi
          
          echo "✓ API response validation complete"
      
      - name: Security Checks
        run: |
          if grep -r "mysql_query\|mysqli_query\|pg_query" --include="*.php" . | grep -v "test\|vendor" | grep -v "^$"; then
            echo "❌ CRITICAL: Potential SQL injection risk detected!"
            exit 1
          fi
          
          if grep -r "echo.*\$_GET\|echo.*\$_POST\|echo.*\$_REQUEST" --include="*.php" . | grep -v "test\|vendor" | grep -v "json_encode"; then
            echo "⚠️  Warning: Potential XSS vulnerability - ensure all output is sanitized"
          fi
          
          if ! grep -q "checkRateLimit" api/weather.php; then
            echo "❌ CRITICAL: Rate limiting not enforced in api/weather.php!"
            exit 1
          fi
          
          if ! grep -q "checkRateLimit" pages/config-generator.php; then
            echo "❌ CRITICAL: Rate limiting not enforced in pages/config-generator.php!"
            exit 1
          fi
          
          if ! grep -q "validatePushWebcamConfig" lib/push-webcam-validator.php; then
            echo "❌ CRITICAL: Push webcam validation function missing!"
            exit 1
          fi
          
          if ! grep -q "max_file_size_mb\|allowed_extensions\|validateImageFile" scripts/process-push-webcams.php; then
            echo "⚠️  Warning: File upload validation may be missing in process-push-webcams.php"
          fi
          
          echo "✓ Security checks complete"
      
      - name: Run VPN Manager Security Tests
        run: |
          if [ ! -f "scripts/test-vpn-manager-security.py" ]; then
            echo "❌ VPN Manager security test file not found"
            exit 1
          fi
          
          python3 scripts/test-vpn-manager-security.py
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "✓ VPN Manager security tests passed"
          else
            echo "❌ VPN Manager security tests failed"
            exit 1
          fi

