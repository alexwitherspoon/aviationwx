name: PR Quality Gates
run-name: "PR #${{ github.event.pull_request.number }} Quality Gates (${{ github.event.pull_request.head.sha }})"

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened, ready_for_review ]

# Prevent concurrent runs - cancel old runs when PR is updated
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Default permissions for all jobs in this workflow
permissions:
  contents: write  # Needed to commit built Leaflet files back to PR
  actions: read
  pull-requests: write  # Needed to comment on PRs

jobs:
  quality-gates:
    name: Quality Gates (Block PR if Failed)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: pcov
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Validate PHP syntax
        run: |
          errors=$(find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; 2>&1 | grep -v "No syntax errors" || true)
          if [ ! -z "$errors" ]; then
            echo "❌ PHP syntax errors found:"
            echo "$errors"
            exit 1
          else
            echo "✓ All PHP files have valid syntax"
          fi
      
      - name: Validate Weather Pipeline Implementation
        run: |
          # Check that UnifiedFetcher is required
          if ! grep -q "require.*UnifiedFetcher\.php\|include.*UnifiedFetcher\.php" api/weather.php; then
            echo "❌ CRITICAL: lib/weather/UnifiedFetcher.php not required in api/weather.php!"
            exit 1
          fi
          
          # Verify fetchWeatherUnified function exists
          if ! grep -q "function fetchWeatherUnified" lib/weather/UnifiedFetcher.php; then
            echo "❌ CRITICAL: fetchWeatherUnified function missing from lib/weather/UnifiedFetcher.php!"
            exit 1
          fi
          
          # Verify WeatherAggregator class exists
          if ! grep -q "class WeatherAggregator" lib/weather/WeatherAggregator.php; then
            echo "❌ CRITICAL: WeatherAggregator class missing from lib/weather/WeatherAggregator.php!"
            exit 1
          fi
          
          # Verify cache-utils.php exists for staleness checking
          if ! grep -q "function nullStaleFieldsBySource" lib/weather/cache-utils.php; then
            echo "❌ CRITICAL: nullStaleFieldsBySource function missing from lib/weather/cache-utils.php!"
            exit 1
          fi
          
          # MAX_STALE_HOURS is defined in lib/constants.php
          if ! grep -q "MAX_STALE_HOURS" lib/constants.php 2>/dev/null; then
            echo "⚠️  Warning: Stale data threshold (MAX_STALE_HOURS) may not be set correctly"
          fi
          
          # VRB handling is in lib/weather/adapter/metar-v1.php
          if ! grep -q "VRB" lib/weather/adapter/metar-v1.php 2>/dev/null; then
            echo "⚠️  Warning: VRB (variable wind direction) handling may be missing"
          fi
          
          if ! grep -q "try.*catch.*Exception\|try.*catch.*Throwable" api/weather.php; then
            echo "⚠️  Warning: Error handling around parsing may be missing"
          fi
          
          echo "✓ Weather pipeline validation complete"
      
      - name: Validate Unified Webcam Worker Implementation
        run: |
          # Check unified webcam worker exists
          if ! grep -q "class WebcamWorker" lib/webcam-worker.php; then
            echo "❌ CRITICAL: WebcamWorker class missing from lib/webcam-worker.php!"
            exit 1
          fi
          
          # Check acquisition strategies exist
          if ! grep -q "class PullAcquisitionStrategy" lib/webcam-acquisition.php; then
            echo "❌ CRITICAL: PullAcquisitionStrategy class missing!"
            exit 1
          fi
          
          if ! grep -q "class PushAcquisitionStrategy" lib/webcam-acquisition.php; then
            echo "❌ CRITICAL: PushAcquisitionStrategy class missing!"
            exit 1
          fi
          
          # Check processing pipeline exists
          if ! grep -q "class ProcessingPipeline" lib/webcam-pipeline.php; then
            echo "❌ CRITICAL: ProcessingPipeline class missing from lib/webcam-pipeline.php!"
            exit 1
          fi
          
          # Check unified worker CLI script exists
          if [ ! -f "scripts/unified-webcam-worker.php" ]; then
            echo "❌ CRITICAL: scripts/unified-webcam-worker.php missing!"
            exit 1
          fi
          
          # Check push webcam validator still exists
          if ! grep -q "function validatePushWebcamConfig" lib/push-webcam-validator.php; then
            echo "❌ CRITICAL: validatePushWebcamConfig function missing!"
            exit 1
          fi
          
          # Check sync-push-config still exists
          if ! grep -q "function syncPushConfig" scripts/sync-push-config.php; then
            echo "❌ CRITICAL: syncPushConfig function missing!"
            exit 1
          fi
          
          # Check image validation exists in pipeline
          if ! grep -q "validateImage\|getimagesize\|mime_content_type" lib/webcam-pipeline.php lib/webcam-acquisition.php; then
            echo "⚠️  Warning: Image file validation may be missing"
          fi
          
          echo "✓ Unified webcam worker validation complete"
      
      - name: Validate Flight Category Logic
        run: |
          # Check that calculator.php is required (functions moved to library)
          if ! grep -q "require.*calculator\.php\|include.*calculator\.php" api/weather.php; then
            echo "❌ CRITICAL: lib/weather/calculator.php not required in api/weather.php!"
            exit 1
          fi
          
          # Verify calculateFlightCategory function exists in calculator.php
          if ! grep -q "function calculateFlightCategory" lib/weather/calculator.php; then
            echo "❌ CRITICAL: calculateFlightCategory function missing from lib/weather/calculator.php!"
            exit 1
          fi
          
          # Verify function is being called in api/weather.php
          if ! grep -q "calculateFlightCategory" api/weather.php; then
            echo "❌ CRITICAL: calculateFlightCategory not being used in api/weather.php!"
            exit 1
          fi
          
          categories=("LIFR" "IFR" "MVFR" "VFR")
          for category in "${categories[@]}"; do
            if ! grep -q "return '$category'" lib/weather/calculator.php; then
              echo "⚠️  Warning: Flight category $category may not be handled in lib/weather/calculator.php"
            fi
          done
          
          echo "✓ Flight category validation complete"
      
      - name: Check for Breaking Changes
        run: |
          critical_functions=(
            "calculateFlightCategory"
            "calculateDensityAltitude"
            "calculatePressureAltitude"
            "nullStaleFieldsBySource"
            "fetchWeatherUnified"
            "validateAirportId"
            "checkRateLimit"
            "checkRateLimitFileBased"
            "checkWeatherCircuitBreaker"
            "recordWeatherFailure"
            "recordWeatherSuccess"
            "checkWebcamCircuitBreaker"
            "recordWebcamFailure"
            "recordWebcamSuccess"
            "validatePushWebcamConfig"
            "syncPushConfig"
          )
          
          for func in "${critical_functions[@]}"; do
            # Check in all relevant files including library files
            if ! grep -rq "function $func" api/weather.php lib/config.php lib/rate-limit.php lib/circuit-breaker.php lib/push-webcam-validator.php scripts/sync-push-config.php lib/weather/calculator.php lib/weather/UnifiedFetcher.php lib/weather/cache-utils.php lib/webcam-worker.php lib/webcam-acquisition.php lib/webcam-pipeline.php 2>/dev/null; then
              echo "❌ CRITICAL: Function $func missing or removed!"
              exit 1
            fi
          done
          
          # Check critical classes exist
          critical_classes=(
            "class WebcamWorker"
            "class ProcessingPipeline"
            "class PullAcquisitionStrategy"
            "class PushAcquisitionStrategy"
          )
          
          for class in "${critical_classes[@]}"; do
            if ! grep -rq "$class" lib/webcam-worker.php lib/webcam-acquisition.php lib/webcam-pipeline.php 2>/dev/null; then
              echo "❌ CRITICAL: $class missing or removed!"
              exit 1
            fi
          done
          
          echo "✓ No breaking changes detected"
      
      - name: Validate API Response Structure
        run: |
          if ! grep -q "Content-Type: application/json" api/weather.php; then
            echo "❌ CRITICAL: API response doesn't set JSON header!"
            exit 1
          fi
          
          if ! grep -q "success.*false" api/weather.php; then
            echo "⚠️  Warning: Error response structure may be missing"
          fi
          
          echo "✓ API response validation complete"
      
      - name: Security Checks
        run: |
          if grep -r "mysql_query\|mysqli_query\|pg_query" --include="*.php" . | grep -v "test\|vendor" | grep -v "^$"; then
            echo "❌ CRITICAL: Potential SQL injection risk detected!"
            exit 1
          fi
          
          if grep -r "echo.*\$_GET\|echo.*\$_POST\|echo.*\$_REQUEST" --include="*.php" . | grep -v "test\|vendor" | grep -v "json_encode"; then
            echo "⚠️  Warning: Potential XSS vulnerability - ensure all output is sanitized"
          fi
          
          if ! grep -q "checkRateLimit" api/weather.php; then
            echo "❌ CRITICAL: Rate limiting not enforced in api/weather.php!"
            exit 1
          fi
          
          if ! grep -q "checkRateLimit" pages/config-generator.php; then
            echo "❌ CRITICAL: Rate limiting not enforced in pages/config-generator.php!"
            exit 1
          fi
          
          if ! grep -q "validatePushWebcamConfig" lib/push-webcam-validator.php; then
            echo "❌ CRITICAL: Push webcam validation function missing!"
            exit 1
          fi
          
          # Check image validation in unified webcam worker
          if ! grep -q "validateImage\|getimagesize\|mime_content_type" lib/webcam-pipeline.php lib/webcam-acquisition.php; then
            echo "⚠️  Warning: File upload validation may be missing in unified webcam worker"
          fi
          
          echo "✓ Security checks complete"
      
      - name: Validate Guides
        run: |
          if [ ! -d "guides" ]; then
            echo "⚠️  Guides directory not found - skipping validation"
            exit 0
          fi
          
          php scripts/validate-guides.php
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "✓ Guides validation passed"
          else
            echo "❌ Guides validation failed"
            exit 1
          fi

  build-leaflet:
    name: Build Leaflet (if package.json changed)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if package.json changed
        id: check-changes
        run: |
          # Check if package.json was modified in this PR
          if git diff --name-only origin/main...HEAD | grep -q "^package.json$"; then
            echo "package-changed=true" >> $GITHUB_OUTPUT
            echo "✓ package.json changed in this PR"
          else
            echo "package-changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️  package.json not changed - skipping Leaflet build"
          fi
      
      - name: Check if Leaflet is in dependencies
        id: check-leaflet
        if: steps.check-changes.outputs.package-changed == 'true'
        run: |
          if grep -q '"leaflet"' package.json; then
            echo "leaflet-present=true" >> $GITHUB_OUTPUT
            echo "✓ Leaflet found in package.json"
          else
            echo "leaflet-present=false" >> $GITHUB_OUTPUT
            echo "ℹ️  Leaflet not in dependencies - skipping build"
          fi
      
      - name: Setup Node.js
        if: steps.check-changes.outputs.package-changed == 'true' && steps.check-leaflet.outputs.leaflet-present == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install npm dependencies
        if: steps.check-changes.outputs.package-changed == 'true' && steps.check-leaflet.outputs.leaflet-present == 'true'
        run: npm install
      
      - name: Build Leaflet files
        if: steps.check-changes.outputs.package-changed == 'true' && steps.check-leaflet.outputs.leaflet-present == 'true'
        run: npm run build:leaflet
      
      - name: Check for changes to built files
        if: steps.check-changes.outputs.package-changed == 'true' && steps.check-leaflet.outputs.leaflet-present == 'true'
        id: check-built-files
        run: |
          # Check if any built files have uncommitted changes
          git add public/js/leaflet.js public/css/leaflet.css public/images/leaflet/ 2>/dev/null || true
          if git diff --staged --quiet; then
            echo "files-changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No changes to built Leaflet files"
          else
            echo "files-changed=true" >> $GITHUB_OUTPUT
            echo "✓ Built files have changes"
            git diff --staged --stat
          fi
      
      - name: Commit built Leaflet files
        if: steps.check-changes.outputs.package-changed == 'true' && steps.check-leaflet.outputs.leaflet-present == 'true' && steps.check-built-files.outputs.files-changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/js/leaflet.js public/css/leaflet.css public/images/leaflet/
          git commit -m "chore: rebuild Leaflet files from updated package.json [skip ci]" || exit 0
          git push || echo "⚠️  Could not push changes (may require manual merge or already up to date)"
          echo "✓ Committed built Leaflet files to PR"

