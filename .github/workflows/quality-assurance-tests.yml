name: Quality Assurance Tests

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch: {} # Allow manual trigger

# Default permissions for all jobs in this workflow
permissions:
  contents: read
  actions: read

jobs:
  # Setup Docker environment once - shared by E2E and browser tests
  setup-docker:
    name: Setup Docker Environment
    runs-on: ubuntu-latest
    # This job sets up Docker and makes it available to dependent jobs
    # Note: We can't share containers across jobs, but we can optimize the setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # This step creates a minimal config for Docker setup only (not used by tests)
          if [ ! -f config/airports.json ]; then
            cp config/airports.json.example config/airports.json
            echo "✓ Created minimal config/airports.json for Docker setup (tests use fixtures)"
          fi
      
      # Note: Docker builds are handled in individual test jobs with layer caching
      # This job only sets up the environment and doesn't build images

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block PR if these fail
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Run Performance Tests
        run: |
          echo "Running performance tests..."
          # Performance tests don't need coverage
          vendor/bin/phpunit --testsuite Performance --testdox --log-junit performance-results.xml --no-coverage || [ $? -le 1 ]
        continue-on-error: true
        env:
          CONFIG_PATH: tests/Fixtures/airports.json.test
      
      - name: Upload Performance Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: performance-results.xml
          retention-days: 7
  
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    # These are critical - must pass before deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # This step creates a minimal config for Docker setup only (not used by tests)
          if [ ! -f config/airports.json ]; then
            cp config/airports.json.example config/airports.json
            echo "✓ Created minimal config/airports.json for Docker setup (tests use fixtures)"
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: aviationwx:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Start Docker containers
        run: |
          # Tag the pre-built image for docker-compose
          docker tag aviationwx:test aviationwx:latest || true
          # Start local instance for testing
          docker compose -f docker/docker-compose.yml up -d
          # Reduced wait time - health check will verify readiness
          sleep 10
          docker compose -f docker/docker-compose.yml ps
      
      - name: Wait for health check
        run: |
          timeout=50
          elapsed=0
          # More aggressive polling - check every 1 second instead of 2
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8080/health.php 2>/dev/null || curl -f http://localhost:8080/ 2>/dev/null; then
              echo "✓ Service is ready after ${elapsed}s"
              exit 0
            fi
            sleep 1
            elapsed=$((elapsed + 1))
            if [ $((elapsed % 5)) -eq 0 ]; then
              echo "Waiting for service... ${elapsed}s"
            fi
          done
          echo "⚠ Service did not become ready in time"
          docker compose -f docker/docker-compose.yml logs web
          exit 1
      
      - name: Run E2E Tests
        run: |
          echo "Running E2E tests with mocked APIs..."
          echo "Note: These tests use mocked API responses"
          # E2E tests don't need coverage - just verify endpoints work
          # Exit code 0 = success, 1 = warnings (tests passed), 2+ = failures
          vendor/bin/phpunit --testsuite E2E --testdox --log-junit e2e-results.xml --no-coverage
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "✓ All E2E tests passed"
          elif [ $exit_code -eq 1 ]; then
            echo "⚠️  E2E tests passed with warnings (this is OK)"
            exit 0  # Treat warnings as success for E2E tests
          else
            echo "❌ E2E tests failed"
            exit $exit_code
          fi
        env:
          TEST_API_URL: http://localhost:8080
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: e2e-results.xml
          retention-days: 7
  
  smoke-tests:
    name: Smoke Tests - Local
    runs-on: ubuntu-latest
    # These are critical - must pass before deployment
    if: github.event_name == 'pull_request' || github.event_name == 'push'  # Auto on PRs and pushes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # This step creates a minimal config for Docker setup only (not used by tests)
          if [ ! -f config/airports.json ]; then
            cp config/airports.json.example config/airports.json
            echo "✓ Created minimal config/airports.json for Docker setup (tests use fixtures)"
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: aviationwx:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Start Docker containers
        run: |
          # Tag the pre-built image for docker-compose
          docker tag aviationwx:test aviationwx:latest || true
          docker compose -f docker/docker-compose.yml up -d
          sleep 10  # Reduced wait time
      
      - name: Wait for health check
        run: |
          timeout=50
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8080/health.php 2>/dev/null || curl -f http://localhost:8080/ 2>/dev/null; then
              echo "✓ Service is ready after ${elapsed}s"
              exit 0
            fi
            sleep 1
            elapsed=$((elapsed + 1))
          done
          echo "⚠ Service did not become ready"
          docker compose -f docker/docker-compose.yml logs web
          exit 1
      
      - name: Run Smoke Tests (Local)
        run: |
          echo "Running smoke tests against local instance..."
          echo "Note: Docker container uses config/airports.json (mounted from host)"
          # Smoke tests don't need coverage - just verify endpoints work
          # Exit code 0 = success, 1 = warnings (tests passed), 2+ = failures
          vendor/bin/phpunit --testsuite Smoke --testdox --log-junit smoke-results.xml --no-coverage
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "✓ All smoke tests passed"
          elif [ $exit_code -eq 1 ]; then
            echo "⚠️  Smoke tests passed with warnings (this is OK)"
            exit 0  # Treat warnings as success for smoke tests
          else
            echo "❌ Smoke tests failed"
            exit $exit_code
          fi
        env:
          TEST_API_URL: http://localhost:8080
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
      
      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: smoke-results.xml
          retention-days: 7
  
  smoke-tests-production:
    name: Smoke Tests - Production (Manual Only)
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event_name == 'workflow_dispatch'  # Only manual dispatch
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Run Smoke Tests (Production)
        run: |
          echo "⚠️  WARNING: Running smoke tests against PRODUCTION"
          echo "Production URL: https://aviationwx.org"
          # Smoke tests don't need coverage - just verify endpoints work
          # Exit code 0 = success, 1 = warnings, 2+ = failures
          vendor/bin/phpunit --testsuite Smoke --testdox --log-junit smoke-prod-results.xml --no-coverage || [ $? -le 1 ]
        continue-on-error: true
        env:
          TEST_PROD_URL: https://aviationwx.org
      
      - name: Upload Production Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-prod-test-results
          path: smoke-prod-results.xml
          retention-days: 7
  
  external-links-tests:
    name: External Links Validation
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block PR if these fail (external services can be flaky)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Run External Links Validation Tests
        run: |
          echo "Validating external links (AirNav, SkyVector, AOPA, FAA Weather)..."
          echo "Note: These tests check URL formats and reachability"
          # External links tests don't need coverage
          vendor/bin/phpunit tests/Integration/ExternalLinksTest.php --testdox --log-junit external-links-results.xml --no-coverage || [ $? -le 1 ]
        continue-on-error: true
        env:
          CONFIG_PATH: tests/Fixtures/airports.json.test
      
      - name: Upload External Links Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: external-links-test-results
          path: external-links-results.xml
          retention-days: 7
  
  # Split browser tests by file for parallelization
  browser-tests:
    name: Browser Tests - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block PR if these fail
    strategy:
      fail-fast: false  # Continue running other matrix jobs even if one fails
      matrix:
        # Run each test file in parallel
        test-file: 
          - 'aviationwx.spec.js'
          - 'cache-and-stale-data.spec.js'
          - 'performance-optimizations.spec.js'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/Browser/package.json
      
      - name: Install Playwright dependencies
        working-directory: tests/Browser
        run: |
          npm install
          # Install only browsers we test in CI (Chromium for desktop + mobile)
          # This speeds up installation significantly
          npx playwright install --with-deps chromium
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # This step creates a minimal config for Docker setup only (not used by tests)
          if [ ! -f config/airports.json ]; then
            cp config/airports.json.example config/airports.json
            echo "✓ Created minimal config/airports.json for Docker setup (tests use fixtures)"
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: aviationwx:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Start Docker containers
        run: |
          # Tag the pre-built image for docker-compose
          docker tag aviationwx:test aviationwx:latest || true
          docker compose -f docker/docker-compose.yml up -d
          sleep 10  # Reduced wait time
          docker compose -f docker/docker-compose.yml ps
      
      - name: Wait for service to be ready
        run: |
          timeout=50
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8080/ 2>/dev/null; then
              echo "✓ Service is ready after ${elapsed}s"
              exit 0
            fi
            sleep 1
            elapsed=$((elapsed + 1))
            if [ $((elapsed % 5)) -eq 0 ]; then
              echo "Waiting for service... ${elapsed}s"
            fi
          done
          echo "⚠ Service did not become ready"
          docker compose -f docker/docker-compose.yml logs web
          exit 1
      
      - name: Run Browser Tests
        working-directory: tests/Browser
        run: |
          # Run only the specific test file from matrix
          # Use sharding to split tests within the file across workers
          npx playwright test tests/${{ matrix.test-file }} || [ $? -eq 1 ]
        continue-on-error: true
        env:
          TEST_BASE_URL: http://localhost:8080
          # Increase workers for faster execution (6 workers for better parallelization)
          PLAYWRIGHT_WORKERS: 6
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.test-file }}
          path: tests/Browser/playwright-report/
          retention-days: 7
      
      - name: Upload Playwright Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.test-file }}
          path: tests/Browser/playwright-results.json
          retention-days: 7
      
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-${{ matrix.test-file }}
          path: tests/Browser/test-results/**/*.png
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
