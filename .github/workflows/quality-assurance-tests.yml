name: Quality Assurance Tests

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch: {} # Allow manual trigger

# CRITICAL: Prevent concurrent runs from interfering with each other
# Group by branch and commit SHA to ensure each commit gets its own run
# Cancel in-progress runs when a new commit is pushed (prevents old runs from completing)
concurrency:
  group: qa-tests-${{ github.ref }}-${{ github.head_ref || github.ref_name }}-${{ github.sha }}
  cancel-in-progress: true  # Cancel old runs when new commit is pushed

# Default permissions for all jobs in this workflow
permissions:
  contents: read
  actions: read

jobs:
  # Test job - runs all PHPUnit tests (unit, integration, critical safety tests)
  test:
    name: PHPUnit Tests
    runs-on: ubuntu-latest
    # Critical - must pass before deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # CRITICAL: Fetch full history to ensure commit SHA is accurate
          fetch-depth: 0
      
      - name: Validate commit and branch context
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Workflow Context Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow Run ID: ${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Verify we're on the expected branch (for push events)
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_name }}" != "main" ]; then
            echo "âš ï¸  Warning: Not on main branch (branch: ${{ github.ref_name }})"
          fi
          
          # Verify commit SHA matches what we checked out
          CHECKED_OUT_SHA=$(git rev-parse HEAD)
          if [ "$CHECKED_OUT_SHA" != "${{ github.sha }}" ]; then
            echo "âŒ CRITICAL: Commit SHA mismatch!"
            echo "  Expected: ${{ github.sha }}"
            echo "  Checked out: $CHECKED_OUT_SHA"
            exit 1
          fi
          echo "âœ“ Commit SHA validated: $CHECKED_OUT_SHA"
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl
          coverage: pcov
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Validate PHP syntax
        run: |
          echo "Checking PHP syntax..."
          errors=$(find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; 2>&1 | grep -v "No syntax errors" || true)
          if [ ! -z "$errors" ]; then
            echo "âŒ PHP syntax errors found:"
            echo "$errors"
            exit 1
          else
            echo "âœ“ All PHP files have valid syntax"
          fi
      
      - name: Run PHPUnit - Unit Tests (Critical)
        run: |
          echo "Running unit tests..."
          echo "Including: ProcessPoolTest, WorkerModeTest, and all other unit tests"
          # Run tests with coverage (pcov is installed)
          vendor/bin/phpunit --testsuite Unit --testdox --log-junit unit-results.xml --coverage-clover unit-coverage.xml || exit_code=$?
          exit_code=${exit_code:-$?}
          # Exit code 0 = success, 1 = warnings, 2+ = failures
          if [ $exit_code -gt 1 ]; then
            echo "âŒ Unit tests failed - check output above"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸  Unit tests passed with warnings"
          else
            echo "âœ“ Unit tests passed"
          fi
      
      - name: Run PHPUnit - Integration Tests
        run: |
          echo "Running integration tests..."
          echo "Including: ProcessPoolIntegrationTest, ProcessPoolOutputTest, and all other integration tests"
          # Run tests with coverage (pcov is installed)
          vendor/bin/phpunit --testsuite Integration --testdox --log-junit integration-results.xml --coverage-clover integration-coverage.xml || exit_code=$?
          exit_code=${exit_code:-$?}
          # Exit code 0 = success, 1 = warnings, 2+ = failures
          if [ $exit_code -gt 1 ]; then
            echo "âŒ Integration tests failed - check output above"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸  Integration tests passed with warnings"
          else
            echo "âœ“ Integration tests passed"
          fi
      
      - name: Run Critical Safety Tests
        run: |
          echo "Running critical safety tests..."
          # These are critical - must pass (allow exit code 1 for warnings)
          vendor/bin/phpunit tests/Unit/StaleDataSafetyTest.php --testdox --stop-on-failure --no-coverage || exit_code1=$?
          exit_code1=${exit_code1:-$?}
          if [ $exit_code1 -gt 1 ]; then
            echo "âŒ StaleDataSafetyTest failed"
            exit 1
          fi
          
          vendor/bin/phpunit tests/Unit/WeatherCalculationsTest.php --testdox --stop-on-failure --no-coverage || exit_code2=$?
          exit_code2=${exit_code2:-$?}
          if [ $exit_code2 -gt 1 ]; then
            echo "âŒ WeatherCalculationsTest failed"
            exit 1
          fi
          
          vendor/bin/phpunit tests/Unit/ErrorHandlingTest.php --testdox --stop-on-failure --no-coverage || exit_code3=$?
          exit_code3=${exit_code3:-$?}
          if [ $exit_code3 -gt 1 ]; then
            echo "âŒ ErrorHandlingTest failed"
            exit 1
          fi
          
          echo "âœ“ Critical safety tests passed (warnings allowed)"
      
      - name: Run Webcam Refresh Initialization Tests
        run: |
          echo "Running webcam refresh initialization tests..."
          echo "Testing CAM_TS initialization and data attributes..."
          vendor/bin/phpunit tests/Unit/WebcamRefreshInitializationTest.php --testdox --stop-on-failure || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "âŒ WebcamRefreshInitializationTest failed"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸  WebcamRefreshInitializationTest passed with warnings (expected in CI without coverage driver)"
          else
            echo "âœ“ WebcamRefreshInitializationTest passed"
          fi
      
      - name: Run Weather Data Merge Tests
        run: |
          echo "Running weather data merge tests..."
          echo "Testing mergeWeatherDataWithFallback function and error handling..."
          # Test the new merge functionality and error handling
          vendor/bin/phpunit tests/Unit/WeatherDataMergeTest.php --testdox --stop-on-failure || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "âŒ WeatherDataMergeTest failed"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸  WeatherDataMergeTest passed with warnings (expected in CI without coverage driver)"
          else
            echo "âœ“ WeatherDataMergeTest passed"
          fi
          
          # Verify merge function exists and VRB wind direction handling
          vendor/bin/phpunit tests/Unit/ErrorHandlingTest.php --filter testParseMETARResponse_VariableWindDirection --testdox || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "âŒ VRB wind direction handling test failed"
            exit 1
          fi
          
          vendor/bin/phpunit tests/Unit/ErrorHandlingTest.php --filter testParseMETARResponse_NonNumericWindSpeed --testdox || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "âŒ Non-numeric wind speed handling test failed"
            exit 1
          fi
          
          echo "âœ“ Weather data merge and error handling tests passed"
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: critical-test-results
          path: |
            unit-results.xml
            integration-results.xml
            unit-coverage.xml
            integration-coverage.xml
          retention-days: 7

  # Lint job - runs code validation, security checks, and file structure validation
  lint:
    name: Code Validation & Linting
    runs-on: ubuntu-latest
    # Critical - must pass before deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit and branch context
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Workflow Context Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow Run ID: ${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          CHECKED_OUT_SHA=$(git rev-parse HEAD)
          if [ "$CHECKED_OUT_SHA" != "${{ github.sha }}" ]; then
            echo "âŒ CRITICAL: Commit SHA mismatch!"
            exit 1
          fi
          echo "âœ“ Commit SHA validated: $CHECKED_OUT_SHA"
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Validate Merge Functionality
        run: |
          echo "ğŸ” Validating merge functionality implementation..."
          
          # Check that mergeWeatherDataWithFallback function exists (moved to lib/weather/staleness.php)
          if ! grep -q "function mergeWeatherDataWithFallback" lib/weather/staleness.php; then
            echo "âŒ CRITICAL: mergeWeatherDataWithFallback function missing!"
            exit 1
          fi
          
          # Check that merge is called before cache write
          if ! grep -q "mergeWeatherDataWithFallback.*existingCache" api/weather.php; then
            echo "âš ï¸  Warning: mergeWeatherDataWithFallback may not be called before cache write"
          fi
          
          # Check for VRB wind direction handling (in METAR adapter)
          if ! grep -q "wdir.*VRB\|'VRB'" lib/weather/adapter/metar-v1.php; then
            echo "âš ï¸  Warning: VRB wind direction handling may be missing"
          fi
          
          # Check for numeric checks on wind data (in METAR adapter)
          if ! grep -q "is_numeric.*wdir\|is_numeric.*wspd" lib/weather/adapter/metar-v1.php; then
            echo "âš ï¸  Warning: Numeric validation for wind data may be missing"
          fi
          
          echo "âœ“ Merge functionality validation complete"
      
      - name: Check for required files
        run: |
          required_files=(
            "index.php"
            "api/weather.php"
            "api/webcam.php"
            "lib/config.php"
            "lib/rate-limit.php"
            "lib/constants.php"
            "lib/circuit-breaker.php"
            "scripts/process-push-webcams.php"
            "scripts/sync-push-config.php"
            "lib/push-webcam-validator.php"
            "pages/config-generator.php"
            "pages/status.php"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
          done
          echo "âœ“ All required files present"
      
      - name: Validate JSON files
        run: |
          if [ -f "config/airports.json.example" ]; then
            php -r "json_decode(file_get_contents('config/airports.json.example'), true); if (json_last_error() !== JSON_ERROR_NONE) { echo 'Invalid JSON: ' . json_last_error_msg() . PHP_EOL; exit(1); }"
            echo "âœ“ config/airports.json.example is valid JSON"
          fi
      
      - name: Test config utilities
        run: |
          php -r "
          require_once 'lib/config.php';
          
          // Test validation
          \$tests = [
            ['kspb', true],
            ['KSPB', true], // Should be lowercased
            ['kx12', true],
            ['invalid!!', false],
            ['', false],
            ['toolong123', false],
            ['ab', false], // Too short
          ];
          
          foreach (\$tests as [\$id, \$expected]) {
            \$result = validateAirportId(\$id);
            if (\$result !== \$expected) {
              echo 'FAIL: validateAirportId(\"' . \$id . '\") returned ' . (\$result ? 'true' : 'false') . ', expected ' . (\$expected ? 'true' : 'false') . PHP_EOL;
              exit(1);
            }
          }
          
          echo 'âœ“ Airport ID validation tests passed' . PHP_EOL;
          "
      
      - name: Test push webcam configuration validation
        run: |
          php -r "
          require_once 'lib/push-webcam-validator.php';
          
          // Test push webcam config validation
          \$validConfig = [
            'name' => 'Test Camera',
            'push_config' => [
              'username' => 'aB3xK9mP2qR7vN',
              'password' => 'mK8pL3nQ6rT9vW',
              'protocol' => 'sftp',
              'port' => 2222,
              'max_file_size_mb' => 10,
              'allowed_extensions' => ['jpg', 'jpeg']
            ],
            'refresh_seconds' => 300
          ];
          
          \$result = validatePushWebcamConfig(\$validConfig, 'test', 0);
          
          if (!\$result['valid']) {
            echo 'FAIL: Valid push webcam config was rejected' . PHP_EOL;
            echo 'Errors: ' . implode(', ', \$result['errors']) . PHP_EOL;
            exit(1);
          }
          
          echo 'âœ“ Push webcam configuration validation working' . PHP_EOL;
          "
      
      - name: Check for security issues
        run: |
          # Check for dangerous functions in PHP files
          dangerous_patterns=(
            "eval("
            "base64_decode.*\$_GET"
            "base64_decode.*\$_POST"
            "file_get_contents.*\$_GET"
            "file_get_contents.*\$_POST"
          )
          
          for pattern in "${dangerous_patterns[@]}"; do
            matches=$(grep -r "$pattern" --include="*.php" . | grep -v "test" | grep -v "diagnostics" || true)
            if [ ! -z "$matches" ]; then
              echo "âš ï¸  Potentially dangerous pattern found: $pattern"
              echo "$matches"
              # Don't fail, just warn
            fi
          done
          
          echo "âœ“ Security check complete"
      
      - name: Run VPN Manager Security Tests
        run: |
          echo "Running VPN Manager security tests..."
          if [ ! -f "scripts/test-vpn-manager-security.py" ]; then
            echo "âŒ VPN Manager security test file not found"
            exit 1
          fi
          
          # Python 3 is available by default on ubuntu-latest
          python3 scripts/test-vpn-manager-security.py
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "âœ“ VPN Manager security tests passed"
          else
            echo "âŒ VPN Manager security tests failed"
            exit 1
          fi
      
      - name: Test rate limiting functions
        run: |
          php -r "
          require_once 'lib/rate-limit.php';
          
          // Basic function existence test
          if (!function_exists('checkRateLimit')) {
            echo 'FAIL: checkRateLimit function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('getRateLimitRemaining')) {
            echo 'FAIL: getRateLimitRemaining function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('checkRateLimitFileBased')) {
            echo 'FAIL: checkRateLimitFileBased function not found (file-based fallback)' . PHP_EOL;
            exit(1);
          }
          
          echo 'âœ“ Rate limiting functions exist' . PHP_EOL;
          "
      
      - name: Test circuit breaker functions
        run: |
          php -r "
          require_once 'lib/circuit-breaker.php';
          
          // Check weather-specific wrappers
          if (!function_exists('checkWeatherCircuitBreaker')) {
            echo 'FAIL: checkWeatherCircuitBreaker function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWeatherFailure')) {
            echo 'FAIL: recordWeatherFailure function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWeatherSuccess')) {
            echo 'FAIL: recordWeatherSuccess function not found' . PHP_EOL;
            exit(1);
          }
          
          // Check webcam-specific wrappers
          if (!function_exists('checkWebcamCircuitBreaker')) {
            echo 'FAIL: checkWebcamCircuitBreaker function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWebcamFailure')) {
            echo 'FAIL: recordWebcamFailure function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWebcamSuccess')) {
            echo 'FAIL: recordWebcamSuccess function not found' . PHP_EOL;
            exit(1);
          }
          
          echo 'âœ“ Circuit breaker functions exist' . PHP_EOL;
          "
      
      - name: Test constants file
        run: |
          php -r "
          require_once 'lib/constants.php';
          
          // Check that key constants are defined
          \$required_constants = [
            'DEFAULT_WEBCAM_REFRESH',
            'DEFAULT_WEATHER_REFRESH',
            'RATE_LIMIT_WEATHER_MAX',
            'RATE_LIMIT_WEATHER_WINDOW',
            'BACKOFF_BASE_SECONDS',
            'CACHE_FILE_MAX_SIZE',
            'CURL_TIMEOUT',
            'CONFIG_CACHE_TTL',
            'MAX_STALE_HOURS'
          ];
          
          foreach (\$required_constants as \$const) {
            if (!defined(\$const)) {
              echo 'FAIL: Constant ' . \$const . ' not defined' . PHP_EOL;
              exit(1);
            }
          }
          
          echo 'âœ“ Required constants defined' . PHP_EOL;
          "
      
      - name: Validate push webcam functions
        run: |
          php -r "
          // Check that push webcam functions exist
          require_once 'lib/push-webcam-validator.php';
          require_once 'scripts/process-push-webcams.php';
          require_once 'scripts/sync-push-config.php';
          
          \$functions = [
            'validatePushWebcamConfig',
            'processPushWebcams',
            'syncPushConfig',
            'getCameraRefreshSeconds',
            'findNewestValidImage',
            'validateImageFile'
          ];
          
          foreach (\$functions as \$func) {
            if (!function_exists(\$func)) {
              echo 'FAIL: Function ' . \$func . ' not found' . PHP_EOL;
              exit(1);
            }
          }
          
          echo 'âœ“ Push webcam functions exist' . PHP_EOL;
          "
      
      - name: Check Dockerfile
        run: |
          if [ ! -f "docker/Dockerfile" ]; then
            echo "âŒ Dockerfile missing"
            exit 1
          fi
          
          # Check for required components
          grep -q "FROM php:8.3-apache" docker/Dockerfile || (echo "âŒ Dockerfile doesn't use PHP 8.3-apache" && exit 1)
          grep -q "ffmpeg" docker/Dockerfile || (echo "âš ï¸  ffmpeg not found in Dockerfile" || true)
          
          # Check for push webcam dependencies
          grep -q "vsftpd" docker/Dockerfile || (echo "âŒ vsftpd not found in Dockerfile (required for push webcams)" && exit 1)
          grep -q "openssh-server" docker/Dockerfile || (echo "âŒ openssh-server not found in Dockerfile (required for SFTP)" && exit 1)
          grep -q "certbot" docker/Dockerfile || (echo "âš ï¸  certbot not found in Dockerfile (required for FTPS)" || true)
          grep -q "logrotate" docker/Dockerfile || (echo "âš ï¸  logrotate not found in Dockerfile (recommended for FTP/SFTP logs)" || true)
          
          echo "âœ“ Dockerfile checks passed"
      
      - name: Check docker-compose files
        run: |
          if [ ! -f "docker/docker-compose.yml" ] || [ ! -f "docker/docker-compose.prod.yml" ]; then
            echo "âŒ Docker Compose files missing"
            exit 1
          fi
          echo "âœ“ Docker Compose files present"

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block PR if these fail
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Run Performance Tests
        run: |
          echo "Running performance tests..."
          # Performance tests don't need coverage
          vendor/bin/phpunit --testsuite Performance --testdox --log-junit performance-results.xml --no-coverage || [ $? -le 1 ]
        continue-on-error: true
        env:
          CONFIG_PATH: tests/Fixtures/airports.json.test
      
      - name: Upload Performance Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: performance-results.xml
          retention-days: 7
  
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    # These are critical - must pass before deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit and branch context
        run: |
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          CHECKED_OUT_SHA=$(git rev-parse HEAD)
          if [ "$CHECKED_OUT_SHA" != "${{ github.sha }}" ]; then
            echo "âŒ CRITICAL: Commit SHA mismatch!"
            exit 1
          fi
          echo "âœ“ Commit SHA validated: $CHECKED_OUT_SHA"
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # For Docker container, we need a valid config file mounted
          # Use test fixture instead of example (example has invalid keys like _example_kpdx)
          if [ ! -f config/airports.json ]; then
            cp tests/Fixtures/airports.json.test config/airports.json
            echo "âœ“ Created config/airports.json from test fixture for Docker setup"
          else
            # Verify existing config is valid (not from example with invalid keys)
            if grep -q "_example" config/airports.json; then
              echo "âš ï¸  Existing config has invalid example keys, replacing with test fixture"
              cp tests/Fixtures/airports.json.test config/airports.json
            fi
          fi
          # Verify config file exists and is valid JSON
          if [ ! -f config/airports.json ]; then
            echo "âŒ Failed to create config/airports.json"
            exit 1
          fi
          php -r "json_decode(file_get_contents('config/airports.json'), true); if (json_last_error() !== JSON_ERROR_NONE) { echo 'Invalid JSON: ' . json_last_error_msg() . PHP_EOL; exit(1); }"
          echo "âœ“ Config file is valid JSON"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: aviationwx:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Start Docker containers
        env:
          CONFIG_PATH: ${{ github.workspace }}/config/airports.json
          APP_ENV: testing
        run: |
          # Tag the pre-built image for docker-compose
          docker tag aviationwx:test aviationwx:latest || true
          # Start local instance for testing
          # Environment variables are passed via env: block above
          docker compose -f docker/docker-compose.yml up -d
          # Reduced wait time - health check will verify readiness
          sleep 10
          docker compose -f docker/docker-compose.yml ps
      
      - name: Wait for health check
        run: |
          timeout=60
          elapsed=0
          # More aggressive polling - check every 1 second instead of 2
          while [ $elapsed -lt $timeout ]; do
            # Check basic service availability
            if curl -f http://localhost:8080/health.php 2>/dev/null || curl -f http://localhost:8080/ 2>/dev/null; then
              # Also verify config is loaded by checking weather endpoint
              if curl -f 'http://localhost:8080/api/weather.php?airport=kspb' 2>/dev/null | grep -q '"success"'; then
                echo "âœ“ Service is ready and config loaded after ${elapsed}s"
                exit 0
              else
                echo "Service responding but config not loaded yet... ${elapsed}s"
              fi
            fi
            sleep 1
            elapsed=$((elapsed + 1))
            if [ $((elapsed % 5)) -eq 0 ]; then
              echo "Waiting for service... ${elapsed}s"
            fi
          done
          echo "âš  Service did not become ready in time"
          echo "Container status:"
          docker compose -f docker/docker-compose.yml ps
          echo "Container logs:"
          docker compose -f docker/docker-compose.yml logs web | tail -50
          echo "Config file check:"
          docker compose -f docker/docker-compose.yml exec -T web ls -la /var/www/html/config/ 2>/dev/null || echo "Cannot check config"
          exit 1
      
      - name: Run E2E Tests
        run: |
          echo "Running E2E tests with mocked APIs..."
          echo "Note: These tests use mocked API responses"
          # E2E tests don't need coverage - just verify endpoints work
          # Exit code 0 = success, 1 = warnings (tests passed), 2+ = failures
          vendor/bin/phpunit --testsuite E2E --testdox --log-junit e2e-results.xml --no-coverage
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "âœ“ All E2E tests passed"
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸  E2E tests passed with warnings (this is OK)"
            exit 0  # Treat warnings as success for E2E tests
          else
            echo "âŒ E2E tests failed"
            exit $exit_code
          fi
        env:
          TEST_API_URL: http://localhost:8080
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: e2e-results.xml
          retention-days: 7
  
  smoke-tests:
    name: Smoke Tests - Local
    runs-on: ubuntu-latest
    # These are critical - must pass before deployment
    if: github.event_name == 'pull_request' || github.event_name == 'push'  # Auto on PRs and pushes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit and branch context
        run: |
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          CHECKED_OUT_SHA=$(git rev-parse HEAD)
          if [ "$CHECKED_OUT_SHA" != "${{ github.sha }}" ]; then
            echo "âŒ CRITICAL: Commit SHA mismatch!"
            exit 1
          fi
          echo "âœ“ Commit SHA validated: $CHECKED_OUT_SHA"
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # For Docker container, we need a valid config file mounted
          # Use test fixture instead of example (example has invalid keys like _example_kpdx)
          if [ ! -f config/airports.json ]; then
            cp tests/Fixtures/airports.json.test config/airports.json
            echo "âœ“ Created config/airports.json from test fixture for Docker setup"
          else
            # Verify existing config is valid (not from example with invalid keys)
            if grep -q "_example" config/airports.json; then
              echo "âš ï¸  Existing config has invalid example keys, replacing with test fixture"
              cp tests/Fixtures/airports.json.test config/airports.json
            fi
          fi
          # Verify config file exists and is valid JSON
          if [ ! -f config/airports.json ]; then
            echo "âŒ Failed to create config/airports.json"
            exit 1
          fi
          php -r "json_decode(file_get_contents('config/airports.json'), true); if (json_last_error() !== JSON_ERROR_NONE) { echo 'Invalid JSON: ' . json_last_error_msg() . PHP_EOL; exit(1); }"
          echo "âœ“ Config file is valid JSON"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: aviationwx:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Start Docker containers
        run: |
          # Tag the pre-built image for docker-compose
          docker tag aviationwx:test aviationwx:latest || true
          docker compose -f docker/docker-compose.yml up -d
          sleep 10  # Reduced wait time
      
      - name: Wait for health check
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            # Check basic service availability
            if curl -f http://localhost:8080/health.php 2>/dev/null || curl -f http://localhost:8080/ 2>/dev/null; then
              # Also verify config is loaded by checking weather endpoint
              if curl -f 'http://localhost:8080/api/weather.php?airport=kspb' 2>/dev/null | grep -q '"success"'; then
                echo "âœ“ Service is ready and config loaded after ${elapsed}s"
                exit 0
              else
                echo "Service responding but config not loaded yet... ${elapsed}s"
              fi
            fi
            sleep 1
            elapsed=$((elapsed + 1))
            if [ $((elapsed % 5)) -eq 0 ]; then
              echo "Waiting for service... ${elapsed}s"
            fi
          done
          echo "âš  Service did not become ready"
          echo "Container status:"
          docker compose -f docker/docker-compose.yml ps
          echo "Container logs:"
          docker compose -f docker/docker-compose.yml logs web | tail -50
          echo "Config file check:"
          docker compose -f docker/docker-compose.yml exec -T web ls -la /var/www/html/config/ 2>/dev/null || echo "Cannot check config"
          exit 1
      
      - name: Run Smoke Tests (Local)
        run: |
          echo "Running smoke tests against local instance..."
          echo "Note: Docker container uses config/airports.json (mounted from host)"
          # Smoke tests don't need coverage - just verify endpoints work
          # Exit code 0 = success, 1 = warnings (tests passed), 2+ = failures
          vendor/bin/phpunit --testsuite Smoke --testdox --log-junit smoke-results.xml --no-coverage
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "âœ“ All smoke tests passed"
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸  Smoke tests passed with warnings (this is OK)"
            exit 0  # Treat warnings as success for smoke tests
          else
            echo "âŒ Smoke tests failed"
            exit $exit_code
          fi
        env:
          TEST_API_URL: http://localhost:8080
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
      
      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: smoke-results.xml
          retention-days: 7
  
  smoke-tests-production:
    name: Smoke Tests - Production (Manual Only)
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event_name == 'workflow_dispatch'  # Only manual dispatch
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Run Smoke Tests (Production)
        run: |
          echo "âš ï¸  WARNING: Running smoke tests against PRODUCTION"
          echo "Production URL: https://aviationwx.org"
          # Smoke tests don't need coverage - just verify endpoints work
          # Exit code 0 = success, 1 = warnings, 2+ = failures
          vendor/bin/phpunit --testsuite Smoke --testdox --log-junit smoke-prod-results.xml --no-coverage || [ $? -le 1 ]
        continue-on-error: true
        env:
          TEST_PROD_URL: https://aviationwx.org
      
      - name: Upload Production Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-prod-test-results
          path: smoke-prod-results.xml
          retention-days: 7
  
  external-links-tests:
    name: External Links Validation
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block PR if these fail (external services can be flaky)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, json, mbstring
          coverage: none
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Run External Links Validation Tests
        run: |
          echo "Validating external links (AirNav, SkyVector, AOPA, FAA Weather)..."
          echo "Note: These tests check URL formats and reachability"
          # External links tests don't need coverage
          vendor/bin/phpunit tests/Integration/ExternalLinksTest.php --testdox --log-junit external-links-results.xml --no-coverage || [ $? -le 1 ]
        continue-on-error: true
        env:
          CONFIG_PATH: tests/Fixtures/airports.json.test
      
      - name: Upload External Links Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: external-links-test-results
          path: external-links-results.xml
          retention-days: 7
  
  # Split browser tests by file for parallelization
  browser-tests:
    name: Browser Tests - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block PR if these fail
    strategy:
      fail-fast: false  # Continue running other matrix jobs even if one fails
      matrix:
        # Run each test file in parallel
        test-file: 
          - 'aviationwx.spec.js'
          - 'cache-and-stale-data.spec.js'
          - 'performance-optimizations.spec.js'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/Browser/package.json
      
      - name: Install Playwright dependencies
        working-directory: tests/Browser
        run: |
          npm install
          # Install only browsers we test in CI (Chromium for desktop + mobile)
          # This speeds up installation significantly
          npx playwright install --with-deps chromium
      
      - name: Setup test configuration
        run: |
          # Note: airports.json is NOT in repository - only exists on production host
          # CI uses test fixtures (tests/Fixtures/airports.json.test) via CONFIG_PATH
          # For Docker container, we need a valid config file mounted
          # Use test fixture instead of example (example has invalid keys like _example_kpdx)
          if [ ! -f config/airports.json ]; then
            cp tests/Fixtures/airports.json.test config/airports.json
            echo "âœ“ Created config/airports.json from test fixture for Docker setup"
          else
            # Verify existing config is valid (not from example with invalid keys)
            if grep -q "_example" config/airports.json; then
              echo "âš ï¸  Existing config has invalid example keys, replacing with test fixture"
              cp tests/Fixtures/airports.json.test config/airports.json
            fi
          fi
          # Verify config file exists and is valid JSON
          if [ ! -f config/airports.json ]; then
            echo "âŒ Failed to create config/airports.json"
            exit 1
          fi
          php -r "json_decode(file_get_contents('config/airports.json'), true); if (json_last_error() !== JSON_ERROR_NONE) { echo 'Invalid JSON: ' . json_last_error_msg() . PHP_EOL; exit(1); }"
          echo "âœ“ Config file is valid JSON"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: aviationwx:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Start Docker containers
        run: |
          # Tag the pre-built image for docker-compose
          docker tag aviationwx:test aviationwx:latest || true
          docker compose -f docker/docker-compose.yml up -d
          sleep 10  # Reduced wait time
          docker compose -f docker/docker-compose.yml ps
      
      - name: Wait for service to be ready
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            # Check basic service availability
            if curl -f http://localhost:8080/ 2>/dev/null; then
              # Also verify config is loaded by checking weather endpoint
              if curl -f 'http://localhost:8080/api/weather.php?airport=kspb' 2>/dev/null | grep -q '"success"'; then
                echo "âœ“ Service is ready and config loaded after ${elapsed}s"
                exit 0
              else
                echo "Service responding but config not loaded yet... ${elapsed}s"
              fi
            fi
            sleep 1
            elapsed=$((elapsed + 1))
            if [ $((elapsed % 5)) -eq 0 ]; then
              echo "Waiting for service... ${elapsed}s"
            fi
          done
          echo "âš  Service did not become ready"
          echo "Container status:"
          docker compose -f docker/docker-compose.yml ps
          echo "Container logs:"
          docker compose -f docker/docker-compose.yml logs web | tail -50
          echo "Config file check:"
          docker compose -f docker/docker-compose.yml exec -T web ls -la /var/www/html/config/ 2>/dev/null || echo "Cannot check config"
          exit 1
      
      - name: Run Browser Tests
        working-directory: tests/Browser
        run: |
          # Run only the specific test file from matrix
          # Use sharding to split tests within the file across workers
          npx playwright test tests/${{ matrix.test-file }} || [ $? -eq 1 ]
        continue-on-error: true
        env:
          TEST_BASE_URL: http://localhost:8080
          # Increase workers for faster execution (6 workers for better parallelization)
          PLAYWRIGHT_WORKERS: 6
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.test-file }}
          path: tests/Browser/playwright-report/
          retention-days: 7
      
      - name: Upload Playwright Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.test-file }}
          path: tests/Browser/playwright-results.json
          retention-days: 7
      
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-${{ matrix.test-file }}
          path: tests/Browser/test-results/**/*.png
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down

  # Final job that depends on all critical QA jobs completing successfully
  # This ensures deployment only triggers after ALL quality checks pass
  qa-complete:
    name: Quality Assurance Complete
    runs-on: ubuntu-latest
    needs: [test, lint, e2e-tests, smoke-tests]
    if: always()
    
    steps:
      - name: Validate workflow context
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "QA Completion Job - Context Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Workflow Run ID: ${{ github.run_id }}"
          echo "Event: ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Check all critical jobs succeeded
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Quality Assurance Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Checking critical job results..."
          echo ""
          
          # Check each critical job
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ test job failed"
            exit 1
          fi
          echo "âœ“ test job passed"
          
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "âŒ lint job failed"
            exit 1
          fi
          echo "âœ“ lint job passed"
          
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "âŒ e2e-tests job failed"
            exit 1
          fi
          echo "âœ“ e2e-tests job passed"
          
          if [ "${{ needs.smoke-tests.result }}" != "success" ]; then
            echo "âŒ smoke-tests job failed"
            exit 1
          fi
          echo "âœ“ smoke-tests job passed"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All critical quality assurance checks passed"
          echo "âœ… Ready for deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
