name: Test AviationWX

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer
        extensions: curl, gd, json, mbstring
    
    - name: Check syntax
      run: |
        echo "Checking PHP syntax..."
        php -l index.php
        php -l airport-template.php
        php -l weather.php
        php -l webcam.php
        php -l homepage.php
        php -l 404.php
        php -l fetch-webcam-safe.php
        if [ -f "index.php" ]; then php -l index.php; fi
        if [ -f "airport-template.php" ]; then php -l airport-template.php; fi
    
    - name: Validate JSON
      run: |
        echo "Validating airports.json.example..."
        php -r "json_decode(file_get_contents('airports.json.example'), true); if (json_last_error() !== JSON_ERROR_NONE) { echo 'JSON Error: ' . json_last_error_msg(); exit(1); }"
    
    - name: Test weather API endpoint
      run: |
        # Start PHP server in background
        php -S localhost:8000 > /dev/null 2>&1 &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 2
        
        # Test homepage
        curl -f http://localhost:8000/ || exit 1
        
        # Test JSON validation
        curl -f http://localhost:8000/airports.json.example || exit 1
        
        # Cleanup
        kill $SERVER_PID 2>/dev/null || true
    
    - name: Check for secrets in code
      run: |
        echo "Checking for accidental secrets..."
        if grep -r "bc3bda4a-1c07-432b-b11e-b2402f5b5641" . --exclude-dir=.git; then
          echo "ERROR: Real API keys found in code!"
          exit 1
        fi
        if grep -r "apple32" . --exclude-dir=.git --exclude-dir=cache; then
          echo "ERROR: Real passwords found in code!"
          exit 1
        fi
        echo "✓ No secrets found in code"
    
    - name: Validate file structure
      run: |
        echo "Checking required files exist..."
        test -f index.php || (echo "Missing index.php" && exit 1)
        test -f airport-template.php || (echo "Missing airport-template.php" && exit 1)
        test -f weather.php || (echo "Missing weather.php" && exit 1)
        test -f webcam.php || (echo "Missing webcam.php" && exit 1)
        test -f styles.css || (echo "Missing styles.css" && exit 1)
        test -f airports.json.example || (echo "Missing airports.json.example" && exit 1)
        test -f .gitignore || (echo "Missing .gitignore" && exit 1)
        echo "✓ All required files present"

