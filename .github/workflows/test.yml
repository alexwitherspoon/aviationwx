name: Test and Lint

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
    paths-ignore:
      - "**.md"
      - "**.MD"

# Default permissions for all jobs in this workflow
permissions:
  contents: read
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: apcu, gd, zip, curl, exif
          coverage: pcov
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libimage-exiftool-perl ffmpeg
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
      - name: Validate PHP syntax
        run: |
          echo "Checking PHP syntax..."
          errors=$(find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; 2>&1 | grep -v "No syntax errors" || true)
          if [ ! -z "$errors" ]; then
            echo "‚ùå PHP syntax errors found:"
            echo "$errors"
            exit 1
          else
            echo "‚úì All PHP files have valid syntax"
          fi
      
      - name: Run PHPUnit - Unit Tests (Critical)
        run: |
          echo "Running unit tests..."
          echo "Including: ProcessPoolTest, WorkerModeTest, and all other unit tests"
          # Run tests with coverage (pcov is installed)
          vendor/bin/phpunit --testsuite Unit --testdox --log-junit unit-results.xml --coverage-clover unit-coverage.xml || exit_code=$?
          exit_code=${exit_code:-$?}
          # Exit code 0 = success, 1 = warnings, 2+ = failures
          if [ $exit_code -gt 1 ]; then
            echo "‚ùå Unit tests failed - check output above"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "‚ö†Ô∏è  Unit tests passed with warnings"
          else
            echo "‚úì Unit tests passed"
          fi
      
      - name: Run PHPUnit - Integration Tests
        run: |
          echo "Running integration tests..."
          echo "Including: ProcessPoolIntegrationTest, ProcessPoolOutputTest, and all other integration tests"
          # Run tests with coverage (pcov is installed)
          vendor/bin/phpunit --testsuite Integration --testdox --log-junit integration-results.xml --coverage-clover integration-coverage.xml || exit_code=$?
          exit_code=${exit_code:-$?}
          # Exit code 0 = success, 1 = warnings, 2+ = failures
          if [ $exit_code -gt 1 ]; then
            echo "‚ùå Integration tests failed - check output above"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "‚ö†Ô∏è  Integration tests passed with warnings"
          else
            echo "‚úì Integration tests passed"
          fi
      
      - name: Run Critical Safety Tests
        run: |
          echo "Running critical safety tests..."
          # These are critical - must pass (allow exit code 1 for warnings)
          vendor/bin/phpunit tests/Unit/WeatherCalculationsTest.php --testdox --stop-on-failure --no-coverage || exit_code1=$?
          exit_code1=${exit_code1:-$?}
          if [ $exit_code1 -gt 1 ]; then
            echo "‚ùå WeatherCalculationsTest failed"
            exit 1
          fi
          
          vendor/bin/phpunit tests/Unit/ErrorHandlingTest.php --testdox --stop-on-failure --no-coverage || exit_code2=$?
          exit_code2=${exit_code2:-$?}
          if [ $exit_code2 -gt 1 ]; then
            echo "‚ùå ErrorHandlingTest failed"
            exit 1
          fi
          
          vendor/bin/phpunit tests/Unit/WeatherAggregatorTest.php --testdox --stop-on-failure --no-coverage || exit_code3=$?
          exit_code3=${exit_code3:-$?}
          if [ $exit_code3 -gt 1 ]; then
            echo "‚ùå WeatherAggregatorTest failed"
            exit 1
          fi
          
          echo "‚úì Critical safety tests passed (warnings allowed)"
      
      - name: Run Webcam Refresh Initialization Tests
        run: |
          echo "Running webcam refresh initialization tests..."
          echo "Testing CAM_TS initialization and data attributes..."
          vendor/bin/phpunit tests/Integration/WebcamRefreshInitializationTest.php --testdox --stop-on-failure || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "‚ùå WebcamRefreshInitializationTest failed"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "‚ö†Ô∏è  WebcamRefreshInitializationTest passed with warnings (expected in CI without coverage driver)"
          else
            echo "‚úì WebcamRefreshInitializationTest passed"
          fi
      
      - name: Run Weather Aggregation Tests
        run: |
          echo "Running weather aggregation tests..."
          # Test the unified aggregator
          vendor/bin/phpunit tests/Unit/WeatherAggregatorTest.php --testdox --stop-on-failure || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "‚ùå WeatherAggregatorTest failed"
            exit 1
          elif [ $exit_code -eq 1 ]; then
            echo "‚ö†Ô∏è  WeatherAggregatorTest passed with warnings (expected in CI without coverage driver)"
          else
            echo "‚úì WeatherAggregatorTest passed"
          fi
          
          # Verify VRB wind direction handling
          vendor/bin/phpunit tests/Unit/ErrorHandlingTest.php --filter testParseMETARResponse_VariableWindDirection --testdox || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "‚ùå VRB wind direction handling test failed"
            exit 1
          fi
          
          vendor/bin/phpunit tests/Unit/ErrorHandlingTest.php --filter testParseMETARResponse_NonNumericWindSpeed --testdox || exit_code=$?
          exit_code=${exit_code:-$?}
          if [ $exit_code -gt 1 ]; then
            echo "‚ùå Non-numeric wind speed handling test failed"
            exit 1
          fi
          
          echo "‚úì Weather aggregation and error handling tests passed"
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: critical-test-results
          path: |
            unit-results.xml
            integration-results.xml
            unit-coverage.xml
            integration-coverage.xml
          retention-days: 7
      
      - name: Validate Weather Pipeline
        run: |
          echo "üîç Validating unified weather pipeline..."
          
          # Check that UnifiedFetcher exists
          if ! grep -q "function fetchWeatherUnified" lib/weather/UnifiedFetcher.php; then
            echo "‚ùå CRITICAL: fetchWeatherUnified function missing!"
            exit 1
          fi
          
          # Check that WeatherAggregator exists
          if ! grep -q "class WeatherAggregator" lib/weather/WeatherAggregator.php; then
            echo "‚ùå CRITICAL: WeatherAggregator class missing!"
            exit 1
          fi
          
          # Check for VRB wind direction handling (in METAR adapter)
          if ! grep -q "wdir.*VRB\|'VRB'" lib/weather/adapter/metar-v1.php; then
            echo "‚ö†Ô∏è  Warning: VRB wind direction handling may be missing"
          fi
          
          # Check for numeric checks on wind data (in METAR adapter)
          if ! grep -q "is_numeric.*wdir\|is_numeric.*wspd" lib/weather/adapter/metar-v1.php; then
            echo "‚ö†Ô∏è  Warning: Numeric validation for wind data may be missing"
          fi
          
          echo "‚úì Weather pipeline validation complete"
      
      - name: JavaScript Static Analysis
        run: |
          echo "üîç Checking for PHP functions in JavaScript..."
          php scripts/validate-javascript.php
      
      - name: API Endpoint Validation
        run: |
          echo "üîç Validating API endpoint URLs in JavaScript..."
          
          # Check that weather.php calls use /api/weather.php
          if grep -r "weather\.php" pages/*.php | grep -v "/api/weather\.php" | grep -v "api/weather\.php" | grep -v "//.*weather\.php" | grep -v "\*.*weather\.php"; then
            echo "‚ùå Found weather.php calls that don't use /api/weather.php"
            echo "All weather API calls should use /api/weather.php"
            exit 1
          fi
          
          echo "‚úì All weather API calls use correct endpoint"
      
      - name: Check for required files
        run: |
          required_files=(
            "index.php"
            "api/weather.php"
            "api/webcam.php"
            "lib/config.php"
            "lib/rate-limit.php"
            "lib/constants.php"
            "lib/circuit-breaker.php"
            "scripts/sync-push-config.php"
            "scripts/unified-webcam-worker.php"
            "lib/push-webcam-validator.php"
            "lib/webcam-worker.php"
            "lib/webcam-acquisition.php"
            "lib/webcam-pipeline.php"
            "pages/config-generator.php"
            "pages/status.php"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Required file missing: $file"
              exit 1
            fi
          done
          echo "‚úì All required files present"
      
      - name: Validate JSON files
        run: |
          if [ -f "config/airports.json.example" ]; then
            php -r "json_decode(file_get_contents('config/airports.json.example'), true); if (json_last_error() !== JSON_ERROR_NONE) { echo 'Invalid JSON: ' . json_last_error_msg() . PHP_EOL; exit(1); }"
            echo "‚úì config/airports.json.example is valid JSON"
          fi
      
      - name: Test config utilities
        run: |
          php -r "
          require_once 'lib/config.php';
          
          // Test validation
          \$tests = [
            ['kspb', true],
            ['KSPB', true], // Should be lowercased
            ['kx12', true],
            ['invalid!!', false],
            ['', false],
            [str_repeat('a', 51), false], // Too long (51 chars)
            ['ab', false], // Too short
            ['private-strip-1', true], // Valid with hyphens
            ['helipad-downtown', true], // Valid longer ID
            ['-airport', false], // Leading hyphen
            ['airport-', false], // Trailing hyphen
            ['air--port', false], // Consecutive hyphens
          ];
          
          foreach (\$tests as [\$id, \$expected]) {
            \$result = validateAirportId(\$id);
            if (\$result !== \$expected) {
              echo 'FAIL: validateAirportId(\"' . \$id . '\") returned ' . (\$result ? 'true' : 'false') . ', expected ' . (\$expected ? 'true' : 'false') . PHP_EOL;
              exit(1);
            }
          }
          
          echo '‚úì Airport ID validation tests passed' . PHP_EOL;
          "
      
      - name: Test push webcam configuration validation
        run: |
          php -r "
          require_once 'lib/push-webcam-validator.php';
          
          // Test push webcam config validation
          \$validConfig = [
            'name' => 'Test Camera',
            'push_config' => [
              'username' => 'aB3xK9mP2qR7vN',
              'password' => 'mK8pL3nQ6rT9vW',
              'max_file_size_mb' => 10,
              'allowed_extensions' => ['jpg', 'jpeg']
            ],
            'refresh_seconds' => 300
          ];
          
          \$result = validatePushWebcamConfig(\$validConfig, 'test', 0);
          
          if (!\$result['valid']) {
            echo 'FAIL: Valid push webcam config was rejected' . PHP_EOL;
            echo 'Errors: ' . implode(', ', \$result['errors']) . PHP_EOL;
            exit(1);
          }
          
          echo '‚úì Push webcam configuration validation working' . PHP_EOL;
          "
      
      - name: Check for security issues
        run: |
          # Check for dangerous functions in PHP files
          dangerous_patterns=(
            "eval("
            "base64_decode.*\$_GET"
            "base64_decode.*\$_POST"
            "file_get_contents.*\$_GET"
            "file_get_contents.*\$_POST"
          )
          
          for pattern in "${dangerous_patterns[@]}"; do
            matches=$(grep -r "$pattern" --include="*.php" . | grep -v "test" | grep -v "diagnostics" || true)
            if [ ! -z "$matches" ]; then
              echo "‚ö†Ô∏è  Potentially dangerous pattern found: $pattern"
              echo "$matches"
              # Don't fail, just warn
            fi
          done
          
          echo "‚úì Security check complete"
      
      - name: Test rate limiting functions
        run: |
          php -r "
          require_once 'lib/rate-limit.php';
          
          // Basic function existence test
          if (!function_exists('checkRateLimit')) {
            echo 'FAIL: checkRateLimit function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('getRateLimitRemaining')) {
            echo 'FAIL: getRateLimitRemaining function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('checkRateLimitFileBased')) {
            echo 'FAIL: checkRateLimitFileBased function not found (file-based fallback)' . PHP_EOL;
            exit(1);
          }
          
          echo '‚úì Rate limiting functions exist' . PHP_EOL;
          "
      
      - name: Test circuit breaker functions
        run: |
          php -r "
          require_once 'lib/circuit-breaker.php';
          
          // Check weather-specific wrappers
          if (!function_exists('checkWeatherCircuitBreaker')) {
            echo 'FAIL: checkWeatherCircuitBreaker function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWeatherFailure')) {
            echo 'FAIL: recordWeatherFailure function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWeatherSuccess')) {
            echo 'FAIL: recordWeatherSuccess function not found' . PHP_EOL;
            exit(1);
          }
          
          // Check webcam-specific wrappers
          if (!function_exists('checkWebcamCircuitBreaker')) {
            echo 'FAIL: checkWebcamCircuitBreaker function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWebcamFailure')) {
            echo 'FAIL: recordWebcamFailure function not found' . PHP_EOL;
            exit(1);
          }
          
          if (!function_exists('recordWebcamSuccess')) {
            echo 'FAIL: recordWebcamSuccess function not found' . PHP_EOL;
            exit(1);
          }
          
          echo '‚úì Circuit breaker functions exist' . PHP_EOL;
          "
      
      - name: Test constants file
        run: |
          php -r "
          require_once 'lib/constants.php';
          
          // Check that key constants are defined
          \$required_constants = [
            'DEFAULT_WEBCAM_REFRESH',
            'DEFAULT_WEATHER_REFRESH',
            'RATE_LIMIT_WEATHER_MAX',
            'RATE_LIMIT_WEATHER_WINDOW',
            'BACKOFF_BASE_SECONDS',
            'CACHE_FILE_MAX_SIZE',
            'CURL_TIMEOUT',
            'CONFIG_CACHE_TTL',
            'DEFAULT_STALE_FAILCLOSED_SECONDS'
          ];
          
          foreach (\$required_constants as \$const) {
            if (!defined(\$const)) {
              echo 'FAIL: Constant ' . \$const . ' not defined' . PHP_EOL;
              exit(1);
            }
          }
          
          echo '‚úì Required constants defined' . PHP_EOL;
          "
      
      - name: Validate webcam worker functions and classes
        run: |
          php -r "
          // Check that webcam worker classes and functions exist
          require_once 'lib/push-webcam-validator.php';
          require_once 'scripts/sync-push-config.php';
          require_once 'lib/webcam-worker.php';
          require_once 'lib/webcam-acquisition.php';
          require_once 'lib/webcam-pipeline.php';
          
          // Check required functions
          \$functions = [
            'validatePushWebcamConfig',
            'syncPushConfig',
          ];
          
          foreach (\$functions as \$func) {
            if (!function_exists(\$func)) {
              echo 'FAIL: Function ' . \$func . ' not found' . PHP_EOL;
              exit(1);
            }
          }
          
          // Check required classes
          \$classes = [
            'WebcamWorker',
            'ProcessingPipeline',
            'PullAcquisitionStrategy',
            'PushAcquisitionStrategy',
            'AcquisitionStrategyFactory',
          ];
          
          foreach (\$classes as \$class) {
            if (!class_exists(\$class)) {
              echo 'FAIL: Class ' . \$class . ' not found' . PHP_EOL;
              exit(1);
            }
          }
          
          echo '‚úì Webcam worker functions and classes exist' . PHP_EOL;
          "
      
      - name: Check Dockerfile
        run: |
          if [ ! -f "docker/Dockerfile" ]; then
            echo "‚ùå Dockerfile missing"
            exit 1
          fi
          
          # Check for required components
          grep -q "FROM php:8.3-apache" docker/Dockerfile || (echo "‚ùå Dockerfile doesn't use PHP 8.3-apache" && exit 1)
          grep -q "ffmpeg" docker/Dockerfile || (echo "‚ö†Ô∏è  ffmpeg not found in Dockerfile" || true)
          
          # Check for push webcam dependencies
          grep -q "vsftpd" docker/Dockerfile || (echo "‚ùå vsftpd not found in Dockerfile (required for push webcams)" && exit 1)
          grep -q "openssh-server" docker/Dockerfile || (echo "‚ùå openssh-server not found in Dockerfile (required for SFTP)" && exit 1)
          grep -q "certbot" docker/Dockerfile || (echo "‚ö†Ô∏è  certbot not found in Dockerfile (required for FTPS)" || true)
          grep -q "logrotate" docker/Dockerfile || (echo "‚ö†Ô∏è  logrotate not found in Dockerfile (recommended for FTP/SFTP logs)" || true)
          
          echo "‚úì Dockerfile checks passed"
      
      - name: Check docker-compose files
        run: |
          if [ ! -f "docker/docker-compose.yml" ] || [ ! -f "docker/docker-compose.prod.yml" ]; then
            echo "‚ùå Docker Compose files missing"
            exit 1
          fi
          echo "‚úì Docker Compose files present"
