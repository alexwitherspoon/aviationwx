# CI/CD Refactoring Plan

## Current Issues

1. **Duplicate Workflows**: `test.yml` and `quality-assurance-tests.yml` both run on push/PR
2. **Triple Testing**: PRs trigger `test.yml`, `pr-checks.yml`, AND `quality-assurance-tests.yml`
3. **Redundant Job**: `qa-complete` job just checks what GitHub already tracks
4. **Complex Deploy Checks**: Multiple prerequisite checks that could be simplified
5. **Code Duplication**: Same setup steps repeated in every workflow

## Simplification Strategy

### 1. Consolidate Test Workflows
- **Remove**: `test.yml` (redundant)
- **Keep**: `quality-assurance-tests.yml` as the single source of truth for tests
- **Simplify**: `pr-checks.yml` to only do PR-specific validation (not full tests)

### 2. Remove Redundant Jobs
- **Remove**: `qa-complete` job (GitHub already tracks job dependencies)
- **Simplify**: Deploy workflow to use workflow_run conclusion directly

### 3. Create Reusable Setup
- **Create**: Composite action for PHP setup (reduces duplication)

### 4. Simplify Deploy Prerequisites
- **Simplify**: Use workflow_run conclusion check only (already implemented)
- **Remove**: Redundant QA verification in check-prerequisites

## New Workflow Structure

```
┌─────────────────────────────────────────────────────────┐
│  PR Events                                              │
│  └─► pr-checks.yml (PR-specific validation only)       │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  Push to main / PR to main                              │
│  └─► quality-assurance-tests.yml (comprehensive tests)  │
│      ├─► test (unit + integration)                      │
│      ├─► lint                                           │
│      ├─► e2e-tests                                      │
│      ├─► smoke-tests                                    │
│      └─► browser-tests                                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  QA Tests Complete (success)                            │
│  └─► deploy-docker.yml                                  │
│      ├─► check-qa-passed (fast fail)                    │
│      └─► deploy                                         │
└─────────────────────────────────────────────────────────┘
```

## Benefits

1. **Reduced Complexity**: Fewer workflows, clearer purpose
2. **Faster Feedback**: No duplicate test runs
3. **Better Reliability**: Single source of truth for tests
4. **Easier Maintenance**: Less code duplication
5. **Clearer Intent**: Each workflow has a specific purpose

