# VPN Usage Guide

This guide explains how to set up and use VPN connections for remote airport webcams.

## Overview

The VPN system supports three protocols:
- **WireGuard** - Modern, fast, recommended for new setups
- **OpenVPN** - Widely compatible, good for older equipment
- **IPsec** - Standard protocol, works with most enterprise gear

Each airport can use any protocol that their equipment supports.

## Setting Up a New VPN Connection

### 1. Add VPN Configuration to airports.json

Add a `vpn` section to your airport configuration:

```json
{
  "airports": {
    "kspb": {
      "vpn": {
        "enabled": true,
        "type": "wireguard",
        "connection_name": "kspb_vpn",
        "remote_subnet": "192.168.1.0/24",
        "wireguard": {
          "server_port": 51820
        }
      }
    }
  }
}
```

The VPN manager will automatically:
- Generate server and client keys (for WireGuard)
- Generate PSK (for OpenVPN/IPsec)
- Assign a client IP address
- Create server configuration

### 2. Deploy Configuration

After updating `airports.json`, restart the VPN containers:

```bash
docker-compose restart vpn-manager vpn-wireguard vpn-openvpn vpn-server
```

The manager will generate all necessary keys and configs automatically.

### 3. Generate Client Configuration

Generate the client config file that you'll import into the remote site:

```bash
./scripts/generate-client-config.sh kspb wireguard
```

This creates `config/vpn-clients/kspb.wireguard.conf` with everything the client needs.

### 4. Import at Remote Site

**For UniFi Cloud Gateway:**
1. Download the generated config file
2. Log into UniFi Network
3. Go to Settings > VPN > WireGuard (or OpenVPN)
4. Import the config file
5. Enable the connection

**For other equipment:**
- WireGuard: Import the `.conf` file
- OpenVPN: Import the `.ovpn` file
- IPsec: Use the connection parameters from the config

### 5. Update Webcam URLs

Once VPN is connected, update webcam URLs to use private IPs:

```json
{
  "webcams": [
    {
      "name": "North Camera",
      "url": "rtsp://192.168.1.100:554/stream1",
      "type": "rtsp"
    }
  ]
}
```

## Configuration Options

### WireGuard

```json
{
  "vpn": {
    "enabled": true,
    "type": "wireguard",
    "connection_name": "kspb_vpn",
    "remote_subnet": "192.168.1.0/24",
    "client_ip": "10.0.0.2/32",
    "wireguard": {
      "server_port": 51820,
      "server_private_key": "<auto-generated>",
      "server_public_key": "<auto-generated>",
      "client_private_key": "<auto-generated>",
      "client_public_key": "<auto-generated>"
    }
  }
}
```

Keys are auto-generated on first run. The manager will log the generated keys - copy them into `airports.json` if you need to persist them.

### OpenVPN

```json
{
  "vpn": {
    "enabled": true,
    "type": "openvpn",
    "connection_name": "kspb_vpn",
    "remote_subnet": "192.168.1.0/24",
    "openvpn": {
      "port": 1194,
      "protocol": "udp",
      "psk": "<auto-generated>",
      "cipher": "AES-256-CBC"
    }
  }
}
```

### IPsec

```json
{
  "vpn": {
    "enabled": true,
    "type": "ipsec",
    "connection_name": "kspb_vpn",
    "remote_subnet": "192.168.1.0/24",
    "ipsec": {
      "ike_version": "2",
      "encryption": "aes256gcm128",
      "dh_group": "14",
      "psk": "<your-psk-here>"
    }
  }
}
```

For IPsec, you need to manually set the PSK. Generate a strong random string (32+ characters).

## Environment Variables

Set these in your `.env` file:

```bash
VPN_SERVER_IP=your.public.ip.address
VPN_SUBNET=10.0.0.0/16
```

The server IP is used in client configs so clients know where to connect.

## Checking VPN Status

### View Connection Status

```bash
# WireGuard
docker exec vpn-wireguard wg show

# OpenVPN
docker exec vpn-openvpn cat /var/log/openvpn/openvpn.log

# IPsec
docker exec vpn-server ipsec status
```

### View Manager Logs

```bash
docker logs -f vpn-manager
```

### Check Status File

The manager writes status to `cache/vpn-status.json`:

```bash
cat cache/vpn-status.json
```

## Troubleshooting

### Connection Won't Establish

1. **Check keys/PSK match**: For WireGuard, ensure client config has the right keys. For OpenVPN/IPsec, verify PSK matches on both sides.

2. **Check firewall**: Ensure these ports are open:
   - WireGuard: UDP 51820
   - OpenVPN: UDP 1194
   - IPsec: UDP 500, 4500

3. **Check server IP**: Verify `VPN_SERVER_IP` is correct and reachable from the remote site.

4. **Check logs**: Review container logs for errors:
   ```bash
   docker logs vpn-wireguard
   docker logs vpn-manager
   ```

### Connection Drops

1. Check network stability at remote site
2. Review logs for reconnection attempts
3. Verify NAT traversal is working (especially for IPsec)

### Camera Not Accessible

1. Verify VPN connection is up (check status)
2. Verify camera IP is in the `remote_subnet` range
3. Test connectivity:
   ```bash
   docker exec vpn-manager ping -c 3 192.168.1.100
   ```

## Key Management

### WireGuard Keys

Keys are auto-generated by the server. Both server and client keys are stored in `airports.json`. The client config only includes what the client needs (client private key, server public key).

### Rotating Keys

To rotate keys:

1. Generate new keys (or let manager regenerate)
2. Update `airports.json` with new keys
3. Regenerate client config: `./scripts/generate-client-config.sh kspb wireguard`
4. Deploy new config to remote site
5. Restart VPN containers

### PSK Rotation (OpenVPN/IPsec)

1. Generate new PSK (strong random string)
2. Update `airports.json` with new PSK
3. Update remote site with new PSK
4. Restart VPN containers

## Network Details

- **VPN Subnet**: `10.0.0.0/16` (configurable via `VPN_SUBNET`)
- **Server IP**: `10.0.0.1`
- **Client IPs**: Assigned sequentially starting at `10.0.0.2`

Clients are isolated - they can only reach the server and their remote subnet, not other clients.

## Files

- Client configs: `config/vpn-clients/` (git-ignored)
- Server configs: Generated in shared volumes
- Status file: `cache/vpn-status.json`





