# AviationWX URL Rewriting (when Apache serves directly)
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Note: HTTPS redirection is handled by Nginx in production

    # Handle subdomain requests (Host header preserved by reverse proxy)
    # Match subdomain pattern like kspb.aviationwx.org
    RewriteCond %{HTTP_HOST} ^([^\.]+)\.aviationwx\.org$ [NC]
    # Exclude www, bare domain, and status subdomain
    RewriteCond %1 !^(www|aviationwx|status)$ [NC]
    # Exclude existing PHP files (weather.php, webcam.php, etc.)
    RewriteCond %{REQUEST_FILENAME} !-f
    # Rewrite to index.php with airport parameter
    RewriteRule ^(.*)$ index.php?airport=%1 [QSA,L]

    # Route sitemap.xml to sitemap.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^sitemap\.xml$ sitemap.php [L]

    # Default to index.php for routing
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>

# Security - Protect sensitive files and directories
# Deny access to configuration files
<FilesMatch "^(airports\.json|airports\.json\.test|composer\.json|composer\.lock|phpunit\.xml|\.env|\.gitignore|SECURITY\.md|nginx\.conf|Dockerfile|docker-compose\.yml|docker-compose\.prod\.yml|Makefile)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to test files and directories
<FilesMatch "^test">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to test-local.php and diagnostics
# Note: health.php and ready.php are allowed for monitoring/health checks
<FilesMatch "^(test-local\.php|test-local\.sh|diagnostics\.php|clear-cache\.php|metrics\.php)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to scripts directory
<IfModule mod_rewrite.c>
    RewriteRule ^scripts/ - [F,L]
    RewriteRule ^config/ - [F,L]
    RewriteRule ^tests/ - [F,L]
    RewriteRule ^\.github/ - [F,L]
    RewriteRule ^vendor/ - [F,L]
    RewriteRule ^node_modules/ - [F,L]
</IfModule>

# Deny access to hidden files (starting with .)
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Cache webcam images for better performance (nginx handles this in production)
# <FilesMatch "\.jpg$">
#     ExpiresActive On
#     ExpiresDefault "access plus 1 minute"
# </FilesMatch>

# PHP Settings
<IfModule mod_php.c>
    php_value upload_max_filesize 20M
    php_value post_max_size 20M
    php_value memory_limit 256M
    php_value max_execution_time 120
</IfModule>
